# Claude Code Hook 테스트 결과

- **테스트 일시**: 2026-02-24
- **session_id**: `250802d8-d969-4006-81f1-1850e9e79f19`
- **cwd**: `C:\Users\ahnbu\.claude\my-claude-plugins`
- **model**: `claude-opus-4-6`

## 테스트 환경

`~/.claude/settings.json`의 `hooks`에 3개 이벤트(SessionStart, Stop, UserPromptSubmit)를 등록하고, 각각 stdin으로 전달되는 JSON을 `/tmp/` 파일에 덤프하는 방식으로 테스트.

```json
{
  "SessionStart": [{ "matcher": "startup", "hooks": [{ "type": "command", "command": "bash -c 'cat > /tmp/claude-hook-test-sessionstart.json'", "timeout": 3000 }] }],
  "Stop": [{ "hooks": [{ "type": "command", "command": "bash -c 'cat > /tmp/claude-hook-test-stop.json'", "timeout": 3000 }] }],
  "UserPromptSubmit": [{ "hooks": [{ "type": "command", "command": "bash -c 'cat > /tmp/claude-hook-test-userprompt.json'", "timeout": 3000 }] }]
}
```

## 테스트 절차

1. 터미널 A에서 세션 시작 → 훅 등록 테스트 계획 수립
2. **터미널 A를 종료하지 않은 채** 터미널 B에서 새 세션 시작 (SessionStart 트리거)
3. 터미널 B에서 프롬프트 입력 (UserPromptSubmit 트리거)
4. 3개 덤프 파일 존재 여부 및 JSON 파싱 확인

## 결과 요약

| 훅 이벤트 | 파일 | 결과 |
|-----------|------|------|
| SessionStart | `/tmp/claude-hook-test-sessionstart.json` | ✅ 성공 |
| Stop | `/tmp/claude-hook-test-stop.json` | ✅ 성공 |
| UserPromptSubmit | `/tmp/claude-hook-test-userprompt.json` | ✅ 성공 |

## 각 훅이 수신한 데이터

### SessionStart

```json
{
  "session_id": "250802d8-d969-4006-81f1-1850e9e79f19",
  "transcript_path": "C:\\Users\\ahnbu\\.claude\\projects\\...\\250802d8-d969-4006-81f1-1850e9e79f19.jsonl",
  "cwd": "C:\\Users\\ahnbu\\.claude\\my-claude-plugins",
  "hook_event_name": "SessionStart",
  "source": "startup",
  "model": "claude-opus-4-6"
}
```

**수신 필드**: `session_id`, `transcript_path`, `cwd`, `hook_event_name`, `source`, `model`

### Stop

```json
{
  "session_id": "250802d8-d969-4006-81f1-1850e9e79f19",
  "transcript_path": "C:\\Users\\ahnbu\\.claude\\projects\\...\\250802d8-d969-4006-81f1-1850e9e79f19.jsonl",
  "cwd": "C:\\Users\\ahnbu\\.claude\\my-claude-plugins",
  "permission_mode": "bypassPermissions",
  "hook_event_name": "Stop",
  "stop_hook_active": false,
  "last_assistant_message": "(마지막 응답 텍스트 전체)"
}
```

**수신 필드**: `session_id`, `transcript_path`, `cwd`, `permission_mode`, `hook_event_name`, `stop_hook_active`, `last_assistant_message`

### UserPromptSubmit

```json
{
  "session_id": "250802d8-d969-4006-81f1-1850e9e79f19",
  "transcript_path": "C:\\Users\\ahnbu\\.claude\\projects\\...\\250802d8-d969-4006-81f1-1850e9e79f19.jsonl",
  "cwd": "C:\\Users\\ahnbu\\.claude\\my-claude-plugins",
  "permission_mode": "bypassPermissions",
  "hook_event_name": "UserPromptSubmit",
  "prompt": "테스트결과를 md파일로 생성해줘"
}
```

**수신 필드**: `session_id`, `transcript_path`, `cwd`, `permission_mode`, `hook_event_name`, `prompt`

## 훅별 수신 필드 비교

| 필드 | SessionStart | Stop | UserPromptSubmit |
|------|:---:|:---:|:---:|
| `session_id` | ✅ | ✅ | ✅ |
| `transcript_path` | ✅ | ✅ | ✅ |
| `cwd` | ✅ | ✅ | ✅ |
| `hook_event_name` | ✅ | ✅ | ✅ |
| `permission_mode` | ❌ | ✅ | ✅ |
| `source` | ✅ | ❌ | ❌ |
| `model` | ✅ | ❌ | ❌ |
| `stop_hook_active` | ❌ | ✅ | ❌ |
| `last_assistant_message` | ❌ | ✅ | ❌ |
| `prompt` | ❌ | ❌ | ✅ |

## 해석 및 결론

### 3개 hook 모두 session_id 전달 확인

동일한 세션에서 3개 hook이 모두 같은 `session_id`(`250802d8-...`)를 수신했다. Claude Code는 **모든 hook 이벤트에 공통으로 `session_id`를 stdin JSON에 포함**한다.

### 기존 SessionStart hook 실패 원인 (당초 추정)

이전 세션에서 플러그인 hooks.json의 `capture-session-id.sh`가 디버그 로그조차 생성하지 못한 원인을 당초 stdin 공유 문제로 추정했다:

```
"matcher": "startup",
"hooks": [
  { "command": "node ensure-commands.js" },   ← stdin JSON을 소비?
  { "command": "bash capture-session-id.sh" }  ← 빈 stdin 수신?
]
```

> **⚠️ 정정 (2차·3차 테스트에서 확인)**
>
> 위 "stdin 공유" 가설은 **오결론**이었다. 2차 테스트(`세션id확보_테스트2차_20260224.md`)에서
> 체계적으로 검증한 결과, 실제 원인은 **Windows cmd.exe에서 bash/.sh 실행 불가**(가설 6)로 확정됨.
>
> - `ensure-commands.js`(node) → ✅ 동작 / `capture-session-id.sh`(bash) → ❌ 미실행
> - 스크립트 첫 줄에 무조건 실행 구문을 넣어도 파일 미생성 → **bash 프로세스 자체가 fork되지 않음**
> - stdin을 소비한 것이 아니라, 두 번째 hook의 bash 프로세스가 spawn조차 되지 않은 것
>
> stdin 공유 여부 자체는 미검증 상태이며, 근본 원인이 아님.

### 부가 발견: CLAUDE_ENV_FILE

`capture-session-id.sh`는 `$CLAUDE_ENV_FILE`에 환경변수를 기록하는 방식이었으나, 테스트 결과 `CLAUDE_ENV_FILE`이 비어있었다. 환경변수 방식은 불안정하므로 **파일 기반(`cwd/.claude/.current-session-id`)으로 전환**한다.

### 최종 hook 선정: SessionStart

| 기준 | SessionStart | Stop | UserPromptSubmit |
|------|:---:|:---:|:---:|
| session_id 포함 | ✅ | ✅ | ✅ |
| 발동 빈도 | 세션당 1회 | 매 턴 | 매 프롬프트 |
| 성능 효율 | ★★★ 최소 | ★★☆ | ★★☆ |
| /wrap 시점 가용 | ✅ | ✅ | ✅ |
| 추가 유용 필드 | model, source | last_assistant_message | prompt |

**선정 이유:**
1. **세션당 1회** — 매 턴마다 파일을 덮어쓰는 낭비 없음
2. **가장 이른 시점** — 세션 시작 직후 session_id 확보, 이후 모든 작업에서 즉시 사용 가능
3. **실패 원인 해결 가능** — hooks 배열에서 `ensure-commands.js`와 분리하면 stdin 소비 문제 해결
4. **resume matcher 지원** — `--resume`/`--continue` 시에도 session_id 갱신 가능

### 적용 방안

1. 플러그인 hooks.json: `capture-session-id.sh`를 `ensure-commands.js`와 **별도 배열 항목으로 분리**
2. `capture-session-id.sh`: 환경변수 방식 → 파일 기반(`.claude/.current-session-id`)으로 리팩터
3. SKILL.md: `$CLAUDE_SESSION_ID` 참조 → `cat .claude/.current-session-id` 파일 읽기로 변경
4. 글로벌 settings.json: 테스트용 3개 hook 제거

## 참고

- Stop 훅의 `last_assistant_message`는 마지막 AI 응답 전체를 포함 (마크다운 서식 포함)
- SessionStart는 `matcher: "startup"`으로 세션 시작 시에만 발동 (`resume` 시 별도 matcher 필요)
- `permission_mode`는 SessionStart에서는 전달되지 않음
