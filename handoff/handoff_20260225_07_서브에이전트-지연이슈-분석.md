# 서브에이전트 병렬 실행 지연 이슈 분석

> 날짜: 2026-02-25
> 세션 ID: d00b9d00-2461-46b5-b9e9-61bd3c97dbfa
> 상태: 분석 완료, 대응 방안 논의 필요

---

## 1. 사건 요약

"프로젝트 문서관리 & PM 방법론 조사" 작업에서 3개 서브에이전트를 병렬 실행한 웹 리서치 단계에서 **체감 약 57분 지연**이 발생. 사용자가 작업 중단 후 원인 규명을 요청함.

---

## 2. 타임라인 재구성

| 시각 (UTC) | 이벤트 | 비고 |
|---|---|---|
| 07:15:35 | 세션 시작 (SessionStart hook) | Plan Mode에서 시작 |
| 07:17:07 | 사용자 첫 프롬프트 ("문서관리 조사 계획 수립") | `permissionMode: "plan"` |
| 07:17:11 | Explore 에이전트 1개 실행 (기존 파일 탐색) | haiku 모델, 36.7초 |
| 07:17:55 | Plan 에이전트 결과 수신 | 조사 계획서 초안 |
| ~07:20 | Plan 에이전트(Plan subagent) 실행 → 계획 수립 | 계획 파일 작성 |
| ~07:25 | ExitPlanMode 승인 | 사용자가 계획 승인 |
| — | **(세션 2: 계획 실행 단계)** | 새로운 프롬프트 |
| ~07:30 | 참조 파일 3개 Read (bkit 분석, 비교분석, 사례들) | 정상 완료 |
| ~07:31 | **3개 Task 에이전트 병렬 발사** | Step 1, 2, 3 동시 |
| ~07:31 | **Step 1 (비개발 영역) — 즉시 거부됨** | Plan Mode 재활성화 트리거 |
| ~07:36 | Step 2 (개발 영역) — 완료 | 298초 (≈5분), 27 tool_uses, 50,594 tokens |
| ~07:37 | Step 3 (AI 에이전트 시대) — 완료 | 332초 (≈5.5분), 30 tool_uses, 48,884 tokens |
| ~07:37+ | **Plan Mode 활성화 상태로 메인 에이전트 정지** | 사용자 대기 시작 |
| ~08:27? | 사용자 "왜 57분이나 걸리냐" 항의 | |

---

## 3. 근본 원인 분석

### 3.1 직접 원인: Plan Mode 재활성화

3개 Task 에이전트를 병렬 발사했을 때, **첫 번째 에이전트(Step 1: 비개발 영역)가 거부(rejected)**됨. 거부 응답에 `<system-reminder>` 태그로 **Plan Mode 재진입 지시**가 포함되어 있었고, 이로 인해 메인 에이전트가 Plan Mode로 전환됨.

**거부 응답에 포함된 시스템 메시지:**
```
## Re-entering Plan Mode
You are returning to plan mode after having previously exited it.
A plan file exists at C:\Users\ahnbu\.claude\plans\parallel-fluttering-nest.md
```

Plan Mode에서는 **파일 쓰기/실행이 불가**하므로, 나머지 2개 에이전트 결과가 도착해도 후속 작업(보고서 작성)을 진행할 수 없었음.

### 3.2 왜 첫 번째 에이전트만 거부되었나?

정확한 원인은 불명확하나, 가능성:
- **사용자 권한 모드 설정**: 첫 번째 에이전트 실행 시 사용자가 "거부" 선택한 것으로 로그에 기록됨 (`The user doesn't want to proceed with this tool use. The tool use was rejected`)
- **타이밍**: 3개가 동시에 permission 요청을 보냈을 때, UI에서 첫 번째 것만 거부 처리된 것으로 추정

### 3.3 실제 소요 시간 vs 체감 시간

| 구분 | 시간 |
|---|---|
| Step 2 실제 실행 | ~5분 (298초) |
| Step 3 실제 실행 | ~5.5분 (332초) |
| **Plan Mode 대기 (추정)** | **~45분** |
| 사용자 체감 총 지연 | ~57분 |

**핵심**: 에이전트 실행 자체는 5~6분이었으나, **Plan Mode 재활성화로 인한 교착 상태**가 ~45분간 지속됨. 사용자가 화면을 보지 않다가 돌아왔을 때 57분이 경과한 것.

### 3.4 기여 요인

1. **Plan Mode 잔존 상태**: 이전 계획 단계의 plan 파일(`parallel-fluttering-nest.md`)이 남아 있어, 에이전트 거부 시 자동으로 Plan Mode 재진입이 트리거됨
2. **에이전트 거부 시 복구 로직 부재**: 3개 중 1개가 거부되어도 나머지 2개 결과를 가지고 후속 작업을 진행할 수 있어야 하나, Plan Mode 재진입으로 전체가 중단됨
3. **사용자 알림 부재**: Plan Mode 재진입 시 사용자에게 명시적 알림이 없어, 대기 중인지 작업 중인지 구분 불가

---

## 4. 영향

- **시간 손실**: 사용자 대기 ~57분 (실제 작업은 5분이면 완료)
- **작업 손실**: Step 1 (비개발 영역) 리서치 미완료
- **산출물 영향**: Step 2, 3의 리서치 파일은 정상 저장됨
  - `개발영역_문서관리_리서치_20260225.md` (Step 2)
  - `AI에이전트시대_문서관리_차별점_20260225.md` (Step 3)

---

## 5. 대응 방안 (논의 필요)

### 5.1 즉시 적용 가능

| # | 방안 | 설명 |
|---|---|---|
| A | **Plan Mode 종료 후 plan 파일 정리** | ExitPlanMode 후 즉시 plan 파일 내용을 실행 계획으로 대체하여, 재진입 트리거 최소화 |
| B | **에이전트 거부 시 graceful fallback** | 3개 중 1개 거부 → 나머지 2개 결과만으로 계속 진행하는 판단 규칙 |
| C | **병렬 에이전트 발사 전 권한 확인** | 에이전트 실행 전 `permissionMode` 확인 후 충돌 가능성 사전 감지 |

### 5.2 중기 개선

| # | 방안 | 설명 |
|---|---|---|
| D | **CLAUDE.md에 "Plan Mode 복구 규칙" 추가** | Plan Mode 의도치 않은 재활성화 시 즉시 ExitPlanMode 시도 + 사용자 알림 |
| E | **웹 리서치 에이전트 타임아웃 설정** | 에이전트당 max_turns 또는 시간 제한 설정으로 장기 블로킹 방지 |
| F | **리서치 작업의 분산 전략 재검토** | 3개 병렬 대신 순차 실행 또는 2+1 방식으로 리스크 분산 |

### 5.3 검토 질문

1. Plan Mode 재활성화가 Claude Code 플랫폼의 동작인지, 에이전트 프롬프트의 `system-reminder`에 의한 것인지 확인 필요
2. 에이전트 거부(rejected) 사유가 사용자의 명시적 거부인지, 시스템 자동 거부인지 확인 필요
3. CLAUDE.md에 재발방지 규칙을 추가할 경우 적절한 위치와 문구

---

## 6. 에이전트 실행 로그 상세

### 6.1 Step 1 (비개발 영역) — 거부됨

```
에이전트 타입: general-purpose
프롬프트: "비개발 영역 문서 관리" 웹 리서치 (PMBOK, PARA, Decision Log 등)
결과: rejected
거부 메시지: "The user doesn't want to proceed with this tool use."
부수 효과: Plan Mode 재활성화 system-reminder 포함
```

### 6.2 Step 2 (개발 영역) — 성공

```
에이전트 타입: general-purpose
에이전트 ID: ac415236c65c75c72
프롬프트: "개발 영역 문서 관리" 웹 리서치 (ADR, Docs-as-Code, API 문서화 등)
결과: 성공
소요 시간: 298,942ms (≈5분)
토큰: 50,594 total
도구 호출: 27회
산출물: 개발영역_문서관리_리서치_20260225.md
```

### 6.3 Step 3 (AI 에이전트 시대) — 성공

```
에이전트 타입: general-purpose
에이전트 ID: acbb62348981c7012
프롬프트: "AI 에이전트 시대 문서 관리" 웹 리서치 (사람용/기계용, Context Engineering 등)
결과: 성공
소요 시간: 332,977ms (≈5.5분)
토큰: 48,884 total
도구 호출: 30회
산출물: AI에이전트시대_문서관리_차별점_20260225.md
```

### 6.4 Plan Mode 재활성화 시 시스템 메시지 전문

```
## Re-entering Plan Mode

You are returning to plan mode after having previously exited it.
A plan file exists at C:\Users\ahnbu\.claude\plans\parallel-fluttering-nest.md
from your previous planning session.

**Before proceeding with any new planning, you should:**
1. Read the existing plan file to understand what was previously planned
2. Evaluate the user's current request against that plan
3. Decide how to proceed:
   - **Different task**: start fresh by overwriting the existing plan
   - **Same task, continuing**: modify the existing plan
4. Continue with the plan process and edit the plan file before calling ExitPlanMode

Plan mode is active. The user indicated that they do not want you to execute yet --
you MUST NOT make any edits, run any non-readonly tools, or otherwise make any changes.
```

---

## 7. 후속 작업

- [ ] 별도 세션에서 대응 방안 5.1~5.3 논의
- [ ] 재발방지 규칙 확정 후 CLAUDE.md 또는 프로젝트 메모리에 반영
- [ ] Step 1 (비개발 영역) 리서치 보완
- [ ] 조사 보고서 최종 작성 완료
