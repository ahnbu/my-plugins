# 검토: my-session-wrap 플러그인 캐시 불일치 + 우회책

> 날짜: 2026-02-25
> 세션 ID: (획득 실패)
> 프로젝트: my-claude-plugins

---

## 요약: 무엇이 문제였고, 어떻게 해결했는가

### 출발점

EEXIST 버그(#27791)로 `/plugin update`가 동작하지 않는 상황에서,
"플러그인을 독립 커맨드/스킬로 설치하면 어떨까?"를 검토하기 시작했다.

### 조사하면서 발견한 것

검토 과정에서 **예상보다 심각한 문제**를 발견했다:

```
개발 레포 (v2.0.0 최신)
     ↓ git push
GitHub
     ↓ git pull
마켓플레이스 (v2.0.0 최신)     ← 여기까지는 동기화됨
     ↓ /plugin update ← ❌ EEXIST로 실패
캐시 (v2.0.0이지만 코드가 구버전) ← Claude Code는 여기서 로딩
```

**버전 번호는 같은데 코드가 다른 상태**였다.
`/wrap` 실행 시 구버전 스킬이 로딩되어 예전 파일명 규칙(`handoff_NN_YYYYMMDD.md`)으로 동작하고 있었다.

### 해결한 문제 3개 + 잔존 이슈 1개

| # | 문제 | 원인 | 해결 |
|---|------|------|------|
| 1 | **캐시 구버전** — `/wrap` 파일명 포맷이 옛날 방식 | `/plugin update` EEXIST 실패 → 캐시 미갱신 | `git pull` + `cp -r`로 캐시 수동 동기화 |
| 2 | **세션 ID 빈 값** — handoff에 세션 ID 미기재 | Hook은 자식 프로세스라 부모 환경변수 설정 불가 | `$CLAUDE_SESSION_ID` → `cat .claude/.current-session-id` (파일 기반) |
| 3 | **스크립트 경로 1회 실패** — Claude가 잘못된 경로 시도 | `${baseDir}`가 시스템 변수가 아님 + Claude가 프로젝트 루트에서 실행 | 상대 경로로 변경했으나 **미해결** — Claude 자력 복구에 의존 |
| 4 | **Write 1회 실패** — 빈 파일에 쓰기 거부 | `next-handoff.sh`의 `touch`가 빈 파일 생성 | ✅ `touch` 제거 — 3차 테스트에서 해결 확인 |

### 최종 상태 (4차 E2E 완료)

| 항목 | 1차 | 2차 | 3차 | 4차 (일반 프로젝트) | 최종 |
|------|-----|-----|-----|-------------------|------|
| 파일명 포맷 | ✅ | ✅ | ✅ | ✅ | 해결 |
| 세션 ID | ❌ 빈 값 | ✅ | ✅ | ✅ | 해결 |
| 스크립트 경로 | ⚠️ 1회 실패 | ✅ | ⚠️ 1회 실패 | ⚠️ 3-4회 시도 | 수용 (아래 참조) |
| Write 도구 | ⚠️ 빈 파일 | ⚠️ 동일 | ✅ | ✅ | 해결 |

**스크립트 경로 — 해결 불가, 수용**: SKILL.md의 상대 경로는 cwd(프로젝트 루트) 기준으로 해석되어 항상 실패한다. Claude가 자력 복구하는 경로는 환경에 따라 다르다:
- 개발 레포에서: cwd Glob으로 1-2회 시도 후 성공
- 일반 프로젝트에서: cwd Glob 실패 → 캐시 경로 탐색으로 3-4회 시도 후 성공 (4차 테스트에서 확인)

근본 해결은 Claude Code가 `${SKILL_DIR}` 같은 시스템 변수를 제공하는 것인데, 현재는 없음. 기능적으로 동작하므로 알려진 한계로 수용.

### Q&A: 해결책의 부작용 검토

**Q1. `touch` 제거 시 파일명 일관성이 깨지지 않는가?**

깨지지 않는다. 파일명은 `next-handoff.sh` 내부에서 결정되고(`handoff_${DATE}_${SEQ}_${SUFFIX}.md`), `echo`로 경로를 출력한다. `touch`는 그 경로에 빈 파일을 미리 만드는 것뿐이었다. 제거해도 sh가 파일명을 결정하고, Claude는 그 경로를 받아 Write로 내용만 쓰는 구조는 변하지 않는다.

**Q2. 동시 세션에서 세션 ID가 부정확해질 위험은?**

있다. `capture-session-id.js`는 `${cwd}/.claude/.current-session-id`에 세션 ID를 덮어쓴다. **같은 프로젝트**에서 2개 세션이 동시에 돌면 마지막에 시작한 세션의 ID가 파일에 남으므로, 먼저 시작한 세션이 `/wrap` 시 다른 세션의 ID를 읽을 수 있다.

- 다른 프로젝트 동시 세션: 문제 없음 (`cwd` 기반이라 파일 분리)
- 같은 프로젝트 순차 세션: 문제 없음 (마지막 세션 ID가 정확)
- **같은 프로젝트 동시 세션: 세션 ID 부정확 가능** (현실적 빈도 낮음)

근본 원인은 Claude Code에 Hook → 메인 프로세스로 세션 ID를 전달하는 공식 메커니즘이 없는 것이다. 환경변수도 불가, 파일도 경쟁 조건 있음. 현재로서는 알려진 한계로 수용.

**Q4. `my-claude-plugins` 마켓플레이스에 다른 플러그인도 캐시 불일치가 있는가?**

없다. 마켓플레이스에 4개 플러그인 디렉토리가 있지만, 캐시에 설치된 건 `my-session-wrap` 1개뿐이다.

| 플러그인 | 설치 여부 | 캐시 | 불일치 위험 |
|---------|----------|------|-----------|
| `my-session-wrap` | ✅ 설치 | ✅ | 수동 동기화 완료 |
| `my-cowork` | ❌ 미설치 | ❌ | 해당 없음 |
| `my-session-dashboard` | ❌ 미설치 | ❌ | 해당 없음 |
| `my-session-id` | ❌ 미설치 | ❌ | 해당 없음 |

참고: 용어 정리 — **마켓플레이스**(`my-claude-plugins`)는 플러그인을 묶어 배포하는 git 저장소, **플러그인**(`my-session-wrap` 등)은 그 안의 개별 기능 단위.

**Q5. EEXIST 에러는 여전히 발생하는가?**

발생한다. `/plugin` 실행 시 `Failed to refresh marketplace 'my-claude-plugins': EEXIST: file already exists, mkdir 'C:\Users\ahnbu\.claude\plugins'` 에러가 계속 표시된다. §5의 수동 동기화 워크플로우로 우회 중이며, Anthropic 측 수정 대기.

**Q3. 상대 경로 `scripts/next-handoff.sh`는 어떤 프로젝트에서든 실패하는 것 아닌가?**

맞다. SKILL.md의 상대 경로는 cwd 기준으로 해석되는데, cwd는 항상 프로젝트 루트이지 스킬 디렉토리가 아니다. 따라서 어떤 프로젝트에서든 1회 실패한다.

실패 후 Claude가 Glob으로 스크립트를 찾아 복구하는데, **어디서 찾는지는 cwd에 따라 다르다:**

| cwd | Claude가 찾는 위치 | E2E 테스트에서 확인 |
|-----|-------------------|-------------------|
| 개발 레포 (`~/.claude/my-claude-plugins`) | 개발 레포 내부 | ✅ 3차 테스트에서 확인 |
| 일반 프로젝트 (`~/some-project`) | **미검증** — 프로젝트에 스크립트가 없으므로 캐시 경로를 찾을 수 있는지 불확실 |

~~"Claude가 캐시 경로에서 스크립트를 찾는다"는 미검증 가설이다.~~ → **4차 테스트에서 확인됨.** 일반 프로젝트(스크립트 없는 환경)에서 `/wrap` 실행 시, Claude는 cwd Glob 실패 후 캐시 경로(`~/.claude/plugins/cache/.../scripts/`)까지 탐색하여 스크립트를 찾았다. 다만 상대 경로 실패 → cwd Glob 실패 → 캐시 탐색 → 인자 순서 오류 → 재호출까지 **3-4회 시도** 후 성공하는 패턴.

---

## 1. 현재 상태

### 배경
EEXIST 버그(#27791)로 `/plugin update`가 실패하여 플러그인 캐시가 갱신되지 않는 상황.
사용자가 플러그인 시스템을 우회하여 독립 커맨드/스킬로 설치하는 방안을 검토 요청.

### 발견: 캐시 불일치 (핵심)

초기 분석에서 "v2.0.0이 완벽히 동기화되어 정상 동작 중"이라고 오진했으나,
사용자의 지적으로 실측한 결과 **캐시(런타임)와 마켓플레이스/개발 레포 사이에 실질적 코드 차이가 존재**.

| 위치 | 파일명 포맷 | next-handoff.sh |
|------|------------|-----------------|
| 캐시 (런타임) | `handoff_NN_YYYYMMDD.md` | 요약 인자 없음 |
| 마켓플레이스 | `handoff_YYYYMMDD_NN_한줄요약.md` | 요약 인자 지원 |
| 개발 레포 | `handoff_YYYYMMDD_NN_한줄요약.md` | 요약 인자 지원 |

**원인**: Claude Code는 `~/.claude/plugins/cache/`에서 로딩. `git pull`은 `marketplaces/`만 갱신하고 캐시는 건드리지 않음. `/plugin update`(캐시 갱신 담당)는 EEXIST로 실패.

→ `/wrap` 실행 시 구버전 스킬이 로딩되어 예전 파일명 규칙으로 동작 중이었음.

---

## 2. 우회책 비교

### 옵션 A: 캐시 수동 동기화 (권장)

마켓플레이스 → 캐시로 파일 직접 복사.

```bash
cd ~/.claude/plugins/marketplaces/my-claude-plugins && git pull
cp -r ~/.claude/plugins/marketplaces/my-claude-plugins/my-session-wrap/* \
      ~/.claude/plugins/cache/my-claude-plugins/my-session-wrap/2.0.0/
```

- **장점**: 플러그인 시스템 구조 유지, 변경 최소, EEXIST 해결 후 즉시 정상 복귀
- **단점**: 수동 작업 필요 (자동화 가능)
- **리스크**: 낮음

### 옵션 B: 독립 커맨드/스킬 설치 (사용자 원래 제안)

플러그인 시스템을 우회하여 커맨드/스킬을 독립 배치.

- **장점**: 플러그인 시스템 완전 독립
- **단점**: 훅 이식 불가(settings.json 포맷 변환 필요), `${CLAUDE_PLUGIN_ROOT}` 경로 깨짐, 스크립트 경로 전면 수정, 이중 관리, 원복 복잡
- **리스크**: 중간

### 옵션 C: 캐시 심볼릭 링크 (실험적)

캐시 디렉토리를 마켓플레이스로 symlink.

- **장점**: git pull만으로 자동 동기화
- **단점**: Claude Code symlink 처리 미검증, Windows symlink 권한 이슈
- **리스크**: 높음

---

## 3. 옵션별 테스트 결과 기록표

### 옵션 A: 캐시 수동 동기화

| # | 테스트 항목 | 명령/방법 | 결과 | 비고 |
|---|-----------|----------|------|------|
| A-1 | 마켓플레이스 git pull | `cd ~/.claude/plugins/marketplaces/my-claude-plugins && git pull` | ✅ Already up to date | 이전 세션에서 이미 동기화됨 |
| A-2 | 캐시로 파일 복사 | `cp -r marketplaces/.../my-session-wrap/* cache/.../2.0.0/` | ✅ 성공 | 에러 없이 완료 |
| A-3 | SKILL.md 동기화 확인 | `diff -r cache/.../SKILL.md marketplaces/.../SKILL.md` | ✅ IDENTICAL | 파일명 포맷 `YYYYMMDD_NN_한줄요약` 반영 |
| A-4 | next-handoff.sh 동기화 확인 | `diff -r cache/.../next-handoff.sh marketplaces/.../next-handoff.sh` | ✅ IDENTICAL | 요약 인자 지원 버전 반영 |
| A-5 | 전체 재귀 diff | `diff -r cache/.../2.0.0/ marketplaces/.../my-session-wrap/` | ✅ EXIT_CODE=0 | 모든 파일 일치 |
| A-6 | `/wrap` E2E 테스트 | 새 세션에서 `/wrap` 실행 | ✅ 성공 (부분 이슈 있음) | 아래 E2E 상세 결과 참조 |

#### A-6 E2E 테스트 상세 (새 세션, v2.1.56)

| 항목 | 결과 | 상세 |
|------|------|------|
| 파일명 포맷 | ✅ | `handoff_20260225_09_wrap-e2e테스트.md` — 신규 포맷 정상 |
| next-handoff.sh 요약 인자 | ✅ | `"wrap-e2e테스트"` → 파일명에 반영 |
| 스크립트 경로 해석 | ⚠️ | `${baseDir}/scripts/` 잘못 해석 → 1회 실패 → Glob으로 자력 복구 |
| 세션 ID 캡처 | ❌ | `$CLAUDE_SESSION_ID` 비어있음 — capture-session-id.js 훅 미동작 |
| Write 도구 | ⚠️ | touch된 빈 파일에 Write 시도 → 실패 → Read 후 재시도 성공 |
| handoff 문서 생성 | ✅ | 54줄 정상 작성 (템플릿 준수) |
| git commit 옵션 | ✅ | AskUserQuestion 3개 선택지 정상 제시 |

**결론**: 캐시 동기화(옵션 A)로 **핵심 기능(파일명 포맷) 정상 복구 확인**.

#### 부수 이슈 조사 결과

**이슈 1: 세션 ID 환경변수 — 아키텍처 불가 (버그 아님)**
- Hook은 자식 프로세스 → 부모(Claude Code)의 환경변수 수정 불가 (OS 수준 제약)
- `capture-session-id.js`는 **파일 기반**으로 정상 동작 중 (`${cwd}/.claude/.current-session-id`)
- SKILL.md의 `echo "$CLAUDE_SESSION_ID"` 안내가 잘못됨
- **수정**: `cat .claude/.current-session-id 2>/dev/null` 로 변경

**이슈 2: `${baseDir}` 경로 — 미정의 변수**
- `${baseDir}`는 Claude Code 시스템 변수가 아님 (hooks.json의 `${CLAUDE_PLUGIN_ROOT}`와 다름)
- GitHub #9354: `${CLAUDE_PLUGIN_ROOT}`도 markdown 내에서 확장 안 됨
- Anthropic 공식 스킬은 상대 경로(`./reference/...`) 사용
- **수정**: `bash "scripts/next-handoff.sh"` (상대 경로)로 변경

### 옵션 B: 독립 커맨드/스킬 설치

| # | 테스트 항목 | 결과 | 비고 |
|---|-----------|------|------|
| B-1 | `~/.claude/skills/` 경로 스킬 인식 여부 | 🔲 미수행 | 옵션 A 성공 시 불필요 |
| B-2 | settings.json hooks 포맷 변환 | 🔲 미수행 | 옵션 A 성공 시 불필요 |
| B-3 | 스크립트 절대 경로 참조 동작 | 🔲 미수행 | 옵션 A 성공 시 불필요 |

### 옵션 C: 캐시 심볼릭 링크

| # | 테스트 항목 | 결과 | 비고 |
|---|-----------|------|------|
| C-1 | Windows symlink 생성 | 🔲 미수행 | 리스크 높아 보류 |
| C-2 | Claude Code symlink 인식 | 🔲 미수행 | 리스크 높아 보류 |

---

## 3-2. 피드백 루프

### 잘된 점
- 사용자가 "정말 동작하고 있는가?" 질문으로 오진을 바로잡음
- 3개 경로(캐시/마켓플레이스/개발레포)의 `diff -r`로 실질적 코드 차이 확인

### 실수 → 교훈
- **오진**: installed_plugins.json의 버전 번호(2.0.0)만 보고 "동기화 완료"로 판단
- **교훈**: 버전 번호 일치 ≠ 코드 일치. 실제 파일 내용을 diff로 비교해야 함
- **교훈**: 플러그인 시스템의 3단계 경로(개발→마켓플레이스→캐시)를 이해하고, 어느 경로에서 실제 로딩되는지 확인 필수

---

## 4. 다음 작업

### 즉시
- [x] 옵션 A 실행: 캐시 수동 동기화 (`cp -r`) — ✅ 완료, 전체 diff 일치 확인
- [x] 새 세션에서 `/wrap` E2E 테스트 — ✅ `handoff_20260225_09_wrap-e2e테스트.md` 생성 확인

### 즉시 (부수 이슈 수정)
- [x] SKILL.md: `echo "$CLAUDE_SESSION_ID"` → `cat .claude/.current-session-id` 로 변경 (3개 스킬 모두)
- [x] SKILL.md: `${baseDir}/` 제거 → 상대 경로로 변경 (3개 스킬, 총 7개소)
- [x] 수정 후 캐시 재동기화 (정식 파이프라인: git push → git pull → cp -r)
- [x] 새 세션 E2E 재테스트 — ✅ 전체 PASS (`handoff_20260225_10_wrap-e2e테스트2차.md`)

#### E2E 2차 테스트 결과 (부수 이슈 수정 후)

| 항목 | 1차 (수정 전) | 2차 (수정 후) |
|------|-------------|-------------|
| 파일명 포맷 | ✅ | ✅ |
| 세션 ID 획득 | ❌ 빈 값 ($CLAUDE_SESSION_ID) | ✅ `67349a90-...` (파일 기반) |
| 스크립트 경로 | ⚠️ 1회 실패 후 자력 복구 | ✅ 1회에 정상 도달 |
| Write 도구 | ⚠️ touch 파일에 Write 실패 → Read 후 재시도 | ⚠️ 동일 (next-handoff.sh의 touch 잔존) |

**잔존 이슈**: ~~`next-handoff.sh`의 `touch` 제거 필요~~ → ✅ 제거 완료 (3차 E2E 테스트에서 해결 확인)

#### E2E 3차 테스트 결과 (touch 제거 후, 개발 레포에서)

| 항목 | 결과 | 상세 |
|------|------|------|
| 파일명 포맷 | ✅ | `handoff_20260225_11_wrap-e2e테스트3차.md` |
| 세션 ID | ✅ | `d1bbc9cb-...` (파일 기반) |
| 스크립트 경로 | ⚠️ | 상대 경로 실패 → Glob으로 **개발 레포 내** 스크립트 발견 |
| Write 도구 | ✅ | touch 제거 효과 — 1회에 성공 |

#### E2E 4차 테스트 결과 (일반 프로젝트에서 — 핵심 검증)

**테스트 환경**: `D:\CloudSync\download\클로드코드-플러그인로드fail` (개발 레포가 아닌 일반 프로젝트)

| 항목 | 결과 | 상세 |
|------|------|------|
| 파일명 포맷 | ✅ | `handoff_20260225_01_3차-e2e테스트.md` |
| 세션 ID | ✅ | `23b3b096-...` (파일 기반) |
| 스크립트 경로 (상대) | ❌ | `scripts/next-handoff.sh` → Not Found (프로젝트에 스크립트 없음) |
| 스크립트 경로 (Glob cwd) | ❌ | 현재 프로젝트 내 Glob 실패 |
| 스크립트 경로 (캐시 탐색) | ✅ | **캐시 경로(`~/.claude/plugins/cache/...`)에서 발견** → Q3 가설 확인 |
| 인자 순서 | ⚠️ | 첫 호출에서 HANDOFF_DIR 누락 → 스크립트 Read 후 재호출 성공 |
| Write 도구 | ✅ | 1회 성공 (touch 제거 효과) |

**Q3 가설 확인**: Claude는 cwd에서 스크립트를 못 찾으면, **캐시 경로까지 탐색하여 스크립트를 찾는다.** 다만 상대 경로 실패 → Glob(cwd) 실패 → 캐시 탐색까지 2-3회 시도가 필요하며, 인자 순서까지 틀릴 수 있어 총 3-4회 시도 후 성공하는 패턴.

### 나중
- [ ] EEXIST 해결 후 `/plugin update` 정상 동작 확인
- [ ] handoff 진단문서(`handoff_20260225_05_EEXIST버그-진단.md`)에 캐시 불일치 발견 추가

---

## 5. 플러그인 업데이트 테스트 워크플로우

EEXIST 버그가 해결되기 전까지, 플러그인 수정 후 반영하려면 아래 절차를 따른다.

### 정식 파이프라인

```
개발 레포 ──git push──→ GitHub ──git pull──→ 마켓플레이스 ──cp -r──→ 캐시 ──새 세션──→ E2E 테스트
```

### 명령어

```bash
# Step 1: 개발 레포에서 커밋 & 푸시
cd ~/.claude/my-claude-plugins
git add <변경 파일>
git commit -m "fix(my-session-wrap): ..."
git push

# Step 2: 마켓플레이스 동기화
cd ~/.claude/plugins/marketplaces/my-claude-plugins && git pull

# Step 3: 캐시 동기화
cp -r ~/.claude/plugins/marketplaces/my-claude-plugins/my-session-wrap/* \
      ~/.claude/plugins/cache/my-claude-plugins/my-session-wrap/2.0.0/

# Step 4: 검증
diff -r ~/.claude/plugins/cache/my-claude-plugins/my-session-wrap/2.0.0/ \
        ~/.claude/plugins/marketplaces/my-claude-plugins/my-session-wrap/
# → EXIT=0 이면 동기화 완료

# Step 5: 새 세션에서 E2E 테스트
# (현재 세션은 구버전이 이미 로딩된 상태이므로 반드시 새 세션 필요)
```

### 주의사항

- **캐시 직접 복사 금지**: 개발 레포 → 캐시 직접 복사는 마켓플레이스를 건너뛰어 불일치 유발
- **새 세션 필수**: 캐시 동기화 후 현재 세션에서는 구버전 스킬이 이미 로딩됨
- **EEXIST 해결 후**: 이 워크플로우 대신 `/plugin update` 정상 경로 사용

---

## 6. 핵심 파일 경로

- 캐시 (런타임): `~/.claude/plugins/cache/my-claude-plugins/my-session-wrap/2.0.0/`
- 마켓플레이스: `~/.claude/plugins/marketplaces/my-claude-plugins/`
- 개발 레포: `~/.claude/my-claude-plugins/my-session-wrap/`
- EEXIST 진단: `handoff/handoff_20260225_05_EEXIST버그-진단.md`
