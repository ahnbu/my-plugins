# Session ID 확보 — 2차 테스트 기록

> 작성일: 2026-02-24
> 이전 문서: `세션ID테스트_0차_조사및방안_20260224.md` (0차 조사·선정)
> 목적: 1차에서 채택한 UserPromptSubmit + 플러그인 hook이 실제 동작하는지 검증

---

## 1. 현재 상태 요약

1차 문서에서 **UserPromptSubmit** hook을 채택하고 구현 완료. 커밋 `0695574`까지 반영.
그러나 `/plugin update` 후 새 세션에서 `.claude/.current-session-id` 파일이 생성되지 않는 문제 발생.

---

## 2. 가설 검증 기록

### 가설 1: 스크립트 자체 버그

**테스트**: 수동으로 stdin을 파이프하여 실행
```bash
echo '{"session_id":"test-uuid-123","cwd":"/c/Users/ahnbu/.claude/my-claude-plugins"}' \
  | bash capture-session-id.sh
```
**결과: 기각** — `.claude/.current-session-id`에 `test-uuid-123` 정상 기록됨.

---

### 가설 2: jq 미설치 또는 PATH 문제

**테스트**: `which jq`
**결과: 기각** — `/usr/bin/jq` 존재 확인.

---

### 가설 3: hook이 발동되지 않음

**테스트**: 시스템 리마인더 출력 관찰
**결과: 부분 기각** — 매 프롬프트마다 `UserPromptSubmit hook success: Success` 출력됨.
Claude Code가 hook 이벤트를 **인식하고 처리**하고 있음.

---

### 가설 4: hook "success" 보고되지만 command가 실제 실행되지 않음

**테스트**: 스크립트에 디버그 출력 코드 삽입, 여러 경로로 파일 생성 시도

| 디버그 방법 | 출력 경로 | 파일 생성됨? |
|-------------|-----------|:---:|
| `echo > /tmp/...` | `/tmp/hook-debug-stdin.json` | ❌ |
| `echo > /c/Users/ahnbu/...` | `~/hook-debug-stdin.json` | ❌ |
| 설치 경로 직접 수정 후 재시도 | 동일 | ❌ |
| 스크립트 첫 줄에 무조건 실행 구문 추가 | `~/hook-debug-1.txt` | ❌ |

**결과: 확인** — 스크립트 첫 줄의 무조건 실행 구문(`echo "HOOK_EXECUTED_AT=..."`)조차 파일을 미생성.
**bash 프로세스 자체가 fork되지 않음.**

---

### 가설 5: `bash "..."` 명령어 형식 문제

**배경**: Claude Code 공식 문서의 플러그인 hook 예시는 `bash` 접두사 없이 스크립트 경로만 사용:
```json
// 공식 예시
{ "command": "${CLAUDE_PLUGIN_ROOT}/scripts/format-code.sh" }
// 기존 우리 코드
{ "command": "bash \"${CLAUDE_PLUGIN_ROOT}/hooks/capture-session-id.sh\"" }
```

**적용한 변경**:
```diff
- "command": "bash \"${CLAUDE_PLUGIN_ROOT}/hooks/capture-session-id.sh\""
+ "command": "${CLAUDE_PLUGIN_ROOT}/hooks/capture-session-id.sh"
```

**테스트**: 소스 수정 → `/plugin update` (HTTPS로 재등록) → 새 세션 시작 → 프롬프트 입력

**결과: 기각** — 3개 파일(debug 2개 + session-id) 모두 NOT FOUND. shebang 직접 실행도 실패.

| ~/hook-debug-*.txt | .claude/.current-session-id | 판정 |
|:---:|:---:|------|
| ❌ 없음 | ❌ 없음 | bash 접두사 제거로는 해결 안 됨 |

---

### 가설 6: Windows에서 .sh 파일 실행 불가 (Node.js child_process 한계)

**현재 상태: 미검증 — 다음 테스트 대상**

**근거**:
- 같은 hooks.json의 SessionStart hook은 `node "..."` 형식으로 **정상 동작**:
  ```json
  "command": "node \"${CLAUDE_PLUGIN_ROOT}/hooks/ensure-commands.js\""
  ```
- `node`는 Windows 네이티브 실행 가능, `bash`는 MSYS/Git Bash 환경에서만 사용 가능
- Claude Code의 hook 실행기가 Node.js `child_process.exec()`를 사용한다면, Windows cmd.exe가 셸로 사용되어 `.sh` 파일의 `#!/bin/bash` shebang을 해석하지 못함
- `bash "..."` 명시 호출도, shebang 기반 직접 실행도 모두 실패한 것이 이를 뒷받침

**대응안**: bash 스크립트를 Node.js 스크립트(`capture-session-id.js`)로 전환
```json
"command": "node \"${CLAUDE_PLUGIN_ROOT}/hooks/capture-session-id.js\""
```

**전환 설계**:
- ensure-commands.js와 동일한 패턴 사용 (이미 정상 동작 검증됨)
- stdin에서 JSON 읽기 → `session_id`, `cwd` 파싱 → 파일 저장
- jq 의존성 제거 (Node.js 내장 JSON.parse 사용)

---

### 가설 7: `${CLAUDE_PLUGIN_ROOT}` 미확장 (대기)

환경변수가 확장되지 않아 잘못된 경로로 실행을 시도할 가능성.
가설 6 검증 과정에서 함께 확인 가능 (node 명령이 성공하면 `${CLAUDE_PLUGIN_ROOT}`는 정상 확장되는 것).

---

## 3. 부수 이슈: `/plugin update` SSH 인증 실패

### 증상

```
Failed to refresh marketplace 'my-claude-plugins':
SSH authentication failed. git@github.com: Permission denied (publickey).
```

### 원인

- `known_marketplaces.json`에 `"source": "github"` 형식으로 등록 → SSH(`git@github.com:...`)로 클론 시도
- Windows SSH agent 서비스가 Disabled 상태 (기본값)
- `~/.ssh/` 디렉토리에 SSH 키 파일 자체가 없음 (`known_hosts`만 존재)
- 이전에 동작했던 것은 일시적으로 SSH agent가 실행 중이었거나 credential 캐시가 있었던 것

### 해결

```powershell
# 1. 기존 SSH 등록 제거
/plugin remove my-claude-plugins

# 2. HTTPS URL로 재등록
/plugin add https://github.com/ahnbu/my-claude-plugins.git
```

### SSH agent 영구 설정 (향후 SSH 필요 시)

```powershell
# 관리자 PowerShell에서:
Set-Service ssh-agent -StartupType Automatic
Start-Service ssh-agent
ssh-add ~\.ssh\id_ed25519  # 키 생성 필요
```

---

## 4. 타임라인

| 시점 | 작업 | 결과 |
|------|------|------|
| 세션 시작 | 1차 커밋(`0695574`) 기반으로 검증 시도 | `.current-session-id` 미생성 |
| 가설 1~3 | 스크립트 수동 실행, jq 확인, hook 발동 확인 | 모두 정상 → 스크립트 자체 문제 아님 |
| 가설 4 | 디버그 코드 삽입 (설치 경로 직접 수정 포함) | 디버그 파일도 미생성 → command 미실행 확인 |
| 가설 5 | bash 접두사 제거, 소스 수정 + 커밋(`37c833e`) | - |
| 중간 이슈 | `/plugin update` SSH 실패 | HTTPS로 재등록하여 해결 |
| 가설 5 검증 | 새 세션에서 3개 파일 확인 | 모두 NOT FOUND → 기각 |
| **다음** | **가설 6: Node.js 스크립트로 전환** | **미검증** |

---

## 5. Stop 훅과의 비교 분석

### 1차 테스트에서 Stop 훅이 "성공"한 조건

1차 테스트(`세션ID테스트_1차_훅실측_20260224.md`)에서 Stop 훅은 session_id 수신에 성공했다. 그러나 그 성공은 다음과 같은 **제한된 조건**에서 이루어진 것이다:

| 항목 | 1차 테스트 (Stop 성공) | 2차 테스트 (UserPromptSubmit 실패) |
|------|----------------------|----------------------------------|
| **등록 위치** | 글로벌 `~/.claude/settings.json` | 플러그인 `hooks.json` |
| **command 형식** | `bash -c 'cat > /tmp/...'` (인라인) | `.sh` 스크립트 파일 |
| **실행 환경** | MSYS bash 세션 내에서 직접 실행 | 플러그인 hook 실행기 (cmd.exe 경유 추정) |

### 핵심 결론: 훅 이벤트 종류는 무관

2차 테스트 실패의 원인은 **UserPromptSubmit이라는 훅 이벤트의 문제가 아니다**. 같은 플러그인 hooks.json에서:

- `node "ensure-commands.js"` (SessionStart) → ✅ 정상 동작
- `bash "capture-session-id.sh"` (UserPromptSubmit) → ❌ 미실행
- `capture-session-id.sh` shebang 의존 (UserPromptSubmit) → ❌ 미실행

**node 명령은 성공하고 bash/.sh는 실패한다.** 이는 Claude Code의 플러그인 hook 실행기가 Windows `cmd.exe`를 통해 프로세스를 spawn하기 때문으로 추정된다. `cmd.exe`는 `.sh` shebang을 해석하지 못하고, `bash` 명령이 PATH에 없을 수 있다.

### Stop 훅도 동일 조건이면 실패했을 것

**Stop 훅을 플러그인 hooks.json에 `.sh` 스크립트로 등록했다면 동일하게 실패했을 것이다.** 1차 테스트의 "성공"은 글로벌 settings.json + 인라인 bash 명령이라는 우호적 환경 덕분이지, Stop 훅 고유의 장점이 아니다.

따라서 어떤 훅 이벤트를 선택하든, 플러그인 hook에서 실행하려면 **Node.js 스크립트(.js)로 전환**해야 한다.

---

## 6. 교훈

1. **설치 경로 직접 수정 금지**: `~/.claude/plugins/marketplaces/...`는 `/plugin update` 시 덮어씌워짐. 디버깅이라도 소스 → update → 검증 순서를 지켜야 함.
2. **"hook success" ≠ command 실행**: Claude Code의 hook success 메시지는 hook 이벤트 처리를 의미하며, command 프로세스의 실제 실행 성공과는 별개.
3. **Windows 환경에서 bash 스크립트 hook 사용 불가 (높은 확률)**: node 기반 hook은 동작하지만 bash/shebang 기반은 동작하지 않음. 크로스 플랫폼 호환이 필요하면 Node.js로 작성해야 함.
4. **SSH vs HTTPS**: Windows에서 SSH agent 관리가 번거로우면 HTTPS 등록이 안정적. marketplace 등록 시 `"source": "github"` 형식은 SSH를 사용하므로, 명시적 HTTPS URL로 등록하는 것이 권장됨.
