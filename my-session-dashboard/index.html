<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude 세션 대시보드</title>
<style>
  :root {
    --bg: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #21262d;
    --border: #30363d;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --text-dim: #6e7681;
    --accent: #58a6ff;
    --accent-dim: #1f6feb;
    --user-bg: #1c2333;
    --assistant-bg: #161b22;
    --tool-bg: #1a1e2a;
    --keyword-bg: #1f6feb33;
    --keyword-text: #79c0ff;
    --success: #3fb950;
    --warning: #d29922;
    --plan-accent: #7ee787;
    --plan-bg: #1a2a1a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
  }

  /* Layout: header-row1, filters-row, content */
  .app {
    display: grid;
    grid-template-columns: 380px 1fr;
    grid-template-rows: auto auto 1fr;
    height: 100vh;
  }

  /* Header */
  .header {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 20px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
  }

  .header h1 {
    font-size: 16px;
    font-weight: 600;
    white-space: nowrap;
  }

  .header .stats {
    font-size: 13px;
    color: var(--text-muted);
  }

  .search-box {
    flex: 1;
    max-width: 400px;
    margin-left: auto;
  }

  .search-box input {
    width: 100%;
    padding: 6px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 13px;
    outline: none;
  }

  .search-box input:focus {
    border-color: var(--accent);
  }

  .search-box input::placeholder {
    color: var(--text-dim);
  }

  /* Filters — header 2nd row */
  .filters {
    grid-column: 1 / -1;
    padding: 8px 20px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    overflow-x: auto;
  }

  .filter-btn {
    padding: 4px 10px;
    font-size: 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--text-muted);
    cursor: pointer;
    white-space: nowrap;
  }

  .filter-btn:hover { border-color: var(--accent); color: var(--text); }
  .filter-btn.active { background: var(--accent-dim); border-color: var(--accent); color: #fff; }

  /* Sidebar */
  .sidebar {
    background: var(--bg-secondary);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .session-list {
    flex: 1;
    overflow-y: auto;
  }

  .session-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
  }

  .session-item:hover { background: var(--bg-tertiary); }
  .session-item.active { background: var(--bg-tertiary); border-left: 3px solid var(--accent); }
  .session-item.plan-item { border-left: 3px solid var(--plan-accent); }
  .session-item.plan-item.active { border-left: 3px solid var(--plan-accent); }
  .session-item.completed { opacity: 0.5; }

  .session-title {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 4px;
    word-break: break-all;
    line-height: 1.4;
  }

  .session-preview {
    font-size: 12px;
    color: var(--text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 6px;
  }

  .session-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }

  .session-meta span {
    font-size: 11px;
    color: var(--text-dim);
  }

  .keyword-tag {
    display: inline-block;
    padding: 1px 6px;
    background: var(--keyword-bg);
    color: var(--keyword-text);
    border-radius: 3px;
    font-size: 11px;
  }

  /* Main content */
  .main {
    overflow-y: auto;
    padding: 0;
    display: flex;
    flex-direction: column;
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-dim);
    font-size: 14px;
    gap: 8px;
  }

  .empty-state .icon { font-size: 48px; opacity: 0.3; }

  /* Session detail header */
  .detail-header {
    padding: 16px 24px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
  }

  .detail-header h2 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    word-break: break-all;
  }

  .detail-meta {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    font-size: 12px;
    color: var(--text-muted);
  }

  .detail-meta .label { color: var(--text-dim); }

  /* Messages */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 24px;
  }

  .message {
    margin-bottom: 16px;
    max-width: 900px;
  }

  .message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }

  .role-badge {
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 4px;
  }

  .role-badge.user { background: #1f6feb44; color: var(--accent); }
  .role-badge.assistant { background: #3fb95033; color: var(--success); }

  .message-time {
    font-size: 11px;
    color: var(--text-dim);
  }

  .message-body {
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .message.user .message-body {
    background: var(--user-bg);
    border: 1px solid #1f6feb44;
  }

  .message.assistant .message-body {
    background: var(--assistant-bg);
    border: 1px solid var(--border);
  }

  /* Tool use */
  .tool-block {
    margin-top: 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }

  .tool-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--tool-bg);
    cursor: pointer;
    font-size: 12px;
    color: var(--text-muted);
    user-select: none;
  }

  .tool-header:hover { background: var(--bg-tertiary); }

  .tool-arrow {
    transition: transform 0.2s;
    font-size: 10px;
  }

  .tool-arrow.open { transform: rotate(90deg); }

  .tool-name {
    font-weight: 600;
    color: var(--warning);
  }

  .tool-body {
    display: none;
    padding: 12px;
    background: var(--bg);
    font-size: 12px;
    font-family: "SF Mono", "Fira Code", monospace;
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 300px;
    overflow-y: auto;
    color: var(--text-muted);
    line-height: 1.5;
  }

  .tool-body.open { display: block; }

  /* Markdown-like rendering */
  .message-body code {
    background: var(--bg-tertiary);
    padding: 1px 5px;
    border-radius: 3px;
    font-family: "SF Mono", "Fira Code", monospace;
    font-size: 13px;
  }

  .message-body pre {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    overflow-x: auto;
    margin: 8px 0;
  }

  .message-body pre code {
    background: none;
    padding: 0;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--border); }

  /* Responsive */
  @media (max-width: 768px) {
    .app {
      grid-template-columns: 1fr;
    }
    .sidebar {
      max-height: 40vh;
    }
  }

  .no-results {
    padding: 24px;
    text-align: center;
    color: var(--text-dim);
    font-size: 13px;
  }

  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-dim);
  }

  .type-badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
    vertical-align: middle;
    margin-left: 6px;
  }

  .type-badge.plan { background: var(--plan-bg); color: var(--plan-accent); }
  .type-badge.completed { background: var(--bg-tertiary); color: var(--text-dim); }

  .filter-separator {
    width: 1px;
    background: var(--border);
    align-self: stretch;
    margin: 0 4px;
  }

  /* Plan detail content */
  .plan-content {
    padding: 24px;
    max-width: 900px;
    font-size: 14px;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .plan-content h2 {
    font-size: 18px;
    font-weight: 600;
    margin: 20px 0 8px;
    color: var(--text);
    border-bottom: 1px solid var(--border);
    padding-bottom: 4px;
  }

  .plan-content h3 {
    font-size: 15px;
    font-weight: 600;
    margin: 16px 0 6px;
    color: var(--text);
  }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>Claude 세션</h1>
    <span class="stats" id="stats"></span>
    <div class="search-box">
      <input type="text" id="search" placeholder="세션 검색... (제목, 키워드, 내용)">
    </div>
  </div>

  <div class="filters" id="filters"></div>

  <div class="sidebar">
    <div class="session-list" id="sessionList">
      <div class="loading">세션 로딩 중...</div>
    </div>
  </div>

  <div class="main" id="main">
    <div class="empty-state">
      <div class="icon">&#x1f4ac;</div>
      <div>세션을 선택하면 대화 내용을 볼 수 있습니다</div>
    </div>
  </div>
</div>

<!-- __SESSION_DATA__ -->
<script>
(function() {
  let sessions = [];
  let activeSessionId = null;
  let activeFilter = "all";
  let activeTypeFilter = "all";
  let searchQuery = "";

  const ROLE_LABELS = { user: "사용자", assistant: "어시스턴트" };

  // ── Data Loading (inline) ──
  function loadSessions() {
    sessions = window.__SESSIONS_META__ || [];
    if (sessions.length === 0) {
      document.getElementById("sessionList").innerHTML =
        '<div class="no-results">세션이 없습니다. /ss를 실행하세요</div>';
      return;
    }
    renderStats();
    buildFilters();
    renderSessionList();
  }

  function loadConversation(sessionId) {
    const data = window.__SESSIONS_DATA__ || {};
    return data[sessionId] || [];
  }

  // ── Stats ──
  function renderStats() {
    const sessionCount = sessions.filter((s) => s.type !== "plan").length;
    const planCount = sessions.filter((s) => s.type === "plan").length;
    const totalTokens = sessions.reduce(
      (sum, s) => sum + (s.totalInputTokens || 0) + (s.totalOutputTokens || 0), 0
    );
    const tokenStr = totalTokens > 1_000_000
      ? (totalTokens / 1_000_000).toFixed(1) + "M"
      : totalTokens > 1_000
      ? (totalTokens / 1_000).toFixed(0) + "K"
      : totalTokens;
    const parts = [`${sessionCount}개 세션`];
    if (planCount > 0) parts.push(`${planCount}개 플랜`);
    parts.push(`${tokenStr} 토큰`);
    document.getElementById("stats").textContent = parts.join(" | ");
  }

  // ── Filters ──
  function buildFilters() {
    const projects = [...new Set(sessions.filter((s) => s.type !== "plan").map((s) => s.projectDisplay))];
    const hasPlan = sessions.some((s) => s.type === "plan");
    const container = document.getElementById("filters");

    // 타입 필터
    let html = '<button class="filter-btn active" data-type-filter="all">전체</button>';
    html += '<button class="filter-btn" data-type-filter="session">세션</button>';
    if (hasPlan) {
      html += '<button class="filter-btn" data-type-filter="plan">플랜</button>';
    }

    // 구분선 + 프로젝트 필터
    if (projects.length > 1) {
      html += '<span class="filter-separator"></span>';
      for (const p of projects) {
        const short = p.split(/[/\\]/).pop() || p;
        html += `<button class="filter-btn" data-filter="${escapeAttr(p)}">${escapeHtml(short)}</button>`;
      }
    }
    container.innerHTML = html;

    container.addEventListener("click", (e) => {
      const btn = e.target.closest(".filter-btn");
      if (!btn) return;

      if (btn.dataset.typeFilter !== undefined) {
        // 타입 필터 클릭
        container.querySelectorAll("[data-type-filter]").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        activeTypeFilter = btn.dataset.typeFilter;
      } else if (btn.dataset.filter !== undefined) {
        // 프로젝트 필터 클릭
        container.querySelectorAll("[data-filter]").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        activeFilter = btn.dataset.filter;
      }
      renderSessionList();
    });
  }

  // ── Session List ──
  function getFilteredSessions() {
    return sessions.filter((s) => {
      // 타입 필터
      const sType = s.type || "session";
      if (activeTypeFilter === "session" && sType !== "session") return false;
      if (activeTypeFilter === "plan" && sType !== "plan") return false;
      // 프로젝트 필터 (세션에만 적용)
      if (activeFilter !== "all" && sType === "session" && s.projectDisplay !== activeFilter) return false;
      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        const fields = [
          s.title,
          s.firstMessage,
          ...(s.keywords || []),
          s.projectDisplay,
          s.gitBranch,
        ];
        // plan은 content 앞 2000자도 검색 대상에 포함
        if (sType === "plan") {
          const content = loadConversation(s.sessionId);
          if (typeof content === "string") {
            fields.push(content.substring(0, 2000));
          }
        }
        const searchable = fields.join(" ").toLowerCase();
        if (!searchable.includes(q)) return false;
      }
      return true;
    });
  }

  function renderSessionList() {
    const filtered = getFilteredSessions();
    const container = document.getElementById("sessionList");

    if (filtered.length === 0) {
      container.innerHTML = '<div class="no-results">검색 결과 없음</div>';
      return;
    }

    container.innerHTML = filtered
      .map((s) => {
        const isActive = s.sessionId === activeSessionId;
        const date = new Date(s.timestamp);
        const dateStr = date.toLocaleDateString("ko-KR", {
          year: "numeric", month: "2-digit", day: "2-digit",
        });
        const timeStr = date.toLocaleTimeString("ko-KR", {
          hour: "2-digit", minute: "2-digit", hour12: false,
        });

        const isPlan = s.type === "plan";
        const itemClass = "session-item" +
          (isActive ? " active" : "") +
          (isPlan ? " plan-item" : "") +
          (isPlan && s.isCompleted ? " completed" : "");

        const badge = isPlan
          ? (s.isCompleted
            ? '<span class="type-badge completed">완료</span>'
            : '<span class="type-badge plan">PLAN</span>')
          : "";

        const metaInfo = isPlan
          ? `<span>${s.charCount || 0}자</span>`
          : `<span>${s.messageCount || 0} 메시지</span><span>${s.toolUseCount || 0} 도구</span>`;

        return `
          <div class="${itemClass}"
               data-id="${s.sessionId}" onclick="selectSession('${escapeAttr(s.sessionId)}')">
            <div class="session-title">${escapeHtml(s.title)}${badge}</div>
            <div class="session-preview">${escapeHtml(s.firstMessage || "")}</div>
            <div class="session-meta">
              <span>${dateStr} ${timeStr}</span>
              ${metaInfo}
              ${(s.keywords || []).map((k) => `<span class="keyword-tag">${escapeHtml(k)}</span>`).join("")}
            </div>
          </div>
        `;
      })
      .join("");
  }

  // ── Conversation View ──
  window.selectSession = function(sessionId) {
    activeSessionId = sessionId;
    renderSessionList();

    const meta = sessions.find((s) => s.sessionId === sessionId);
    if (!meta) return;

    if (meta.type === "plan") {
      showPlanDetail(meta);
      return;
    }

    const mainEl = document.getElementById("main");
    const messages = loadConversation(sessionId);

    const duration = meta.lastTimestamp && meta.timestamp
      ? formatDuration(new Date(meta.lastTimestamp) - new Date(meta.timestamp))
      : "-";

    const tokenStr = formatTokens(
      (meta.totalInputTokens || 0) + (meta.totalOutputTokens || 0)
    );

    let html = `
      <div class="detail-header">
        <h2>${escapeHtml(meta.title)}</h2>
        <div class="detail-meta">
          <span><span class="label">프로젝트:</span> ${escapeHtml(meta.projectDisplay || "-")}</span>
          <span><span class="label">브랜치:</span> ${escapeHtml(meta.gitBranch || "-")}</span>
          <span><span class="label">소요시간:</span> ${duration}</span>
          <span><span class="label">토큰:</span> ${tokenStr}</span>
          <span><span class="label">모델:</span> ${escapeHtml((meta.models || []).join(", "))}</span>
        </div>
      </div>
      <div class="messages">
    `;

    for (const msg of messages) {
      const time = msg.timestamp
        ? new Date(msg.timestamp).toLocaleTimeString("ko-KR", {
            hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false,
          })
        : "";

      const roleLabel = ROLE_LABELS[msg.role] || msg.role;

      html += `
        <div class="message ${msg.role}">
          <div class="message-header">
            <span class="role-badge ${msg.role}">${roleLabel}</span>
            <span class="message-time">${time}</span>
          </div>
      `;

      if (msg.text) {
        html += `<div class="message-body">${renderMarkdown(msg.text)}</div>`;
      }

      if (msg.tools && msg.tools.length > 0) {
        for (const tool of msg.tools) {
          const inputStr = formatToolInput(tool);
          html += `
            <div class="tool-block">
              <div class="tool-header" onclick="toggleTool(this)">
                <span class="tool-arrow">&#9654;</span>
                <span class="tool-name">${escapeHtml(tool.name)}</span>
                <span>${toolSummary(tool)}</span>
              </div>
              <div class="tool-body">${escapeHtml(inputStr)}</div>
            </div>
          `;
        }
      }

      html += "</div>";
    }

    html += "</div>";
    mainEl.innerHTML = html;
    mainEl.querySelector(".messages")?.scrollTo(0, 0);
  };

  function showPlanDetail(meta) {
    const mainEl = document.getElementById("main");
    const content = loadConversation(meta.sessionId);
    const date = new Date(meta.timestamp);
    const dateStr = date.toLocaleDateString("ko-KR", {
      year: "numeric", month: "2-digit", day: "2-digit",
    });
    const timeStr = date.toLocaleTimeString("ko-KR", {
      hour: "2-digit", minute: "2-digit", hour12: false,
    });

    const badge = meta.isCompleted
      ? '<span class="type-badge completed">완료</span>'
      : '<span class="type-badge plan">PLAN</span>';

    let html = `
      <div class="detail-header">
        <h2>${escapeHtml(meta.title)} ${badge}</h2>
        <div class="detail-meta">
          <span><span class="label">slug:</span> ${escapeHtml(meta.slug)}</span>
          <span><span class="label">수정일:</span> ${dateStr} ${timeStr}</span>
          <span><span class="label">글자수:</span> ${(meta.charCount || 0).toLocaleString()}자</span>
          ${meta.projectDisplay ? `<span><span class="label">프로젝트:</span> ${escapeHtml(meta.projectDisplay)}</span>` : ""}
        </div>
      </div>
      <div class="plan-content">${renderPlanMarkdown(typeof content === "string" ? content : "")}</div>
    `;
    mainEl.innerHTML = html;
    mainEl.scrollTo(0, 0);
  }

  window.toggleTool = function(el) {
    const arrow = el.querySelector(".tool-arrow");
    const body = el.nextElementSibling;
    arrow.classList.toggle("open");
    body.classList.toggle("open");
  };

  // ── Helpers ──
  function escapeHtml(str) {
    if (!str) return "";
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  function escapeAttr(str) {
    return escapeHtml(str).replace(/'/g, "&#39;");
  }

  function renderMarkdown(text) {
    if (!text) return "";
    let html = escapeHtml(text);

    html = html.replace(
      /\[thinking\] ([\s\S]*?)(?=\n\[thinking\]|\n(?=[A-Z])|\n\n|$)/g,
      '<span style="color:var(--text-dim);font-style:italic">$1</span>'
    );

    html = html.replace(
      /```(\w*)\n([\s\S]*?)```/g,
      '<pre><code>$2</code></pre>'
    );

    html = html.replace(/`([^`]+)`/g, "<code>$1</code>");
    html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

    return html;
  }

  function renderPlanMarkdown(text) {
    if (!text) return "";
    let html = escapeHtml(text);

    // code blocks
    html = html.replace(
      /```(\w*)\n([\s\S]*?)```/g,
      '<pre><code>$2</code></pre>'
    );

    // headings (## and ###)
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h2 style="font-size:20px;margin-top:0">$1</h2>');

    // inline
    html = html.replace(/`([^`]+)`/g, "<code>$1</code>");
    html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

    return html;
  }

  function formatTokens(n) {
    if (n > 1_000_000) return (n / 1_000_000).toFixed(1) + "M";
    if (n > 1_000) return (n / 1_000).toFixed(1) + "K";
    return String(n);
  }

  function formatDuration(ms) {
    const sec = Math.floor(ms / 1000);
    if (sec < 60) return sec + "초";
    const min = Math.floor(sec / 60);
    if (min < 60) return min + "분 " + (sec % 60) + "초";
    const hr = Math.floor(min / 60);
    return hr + "시간 " + (min % 60) + "분";
  }

  function formatToolInput(tool) {
    if (!tool.input) return "(입력 없음)";
    try {
      return JSON.stringify(tool.input, null, 2);
    } catch {
      return String(tool.input);
    }
  }

  function toolSummary(tool) {
    const input = tool.input;
    if (!input) return "";
    if (tool.name === "Read" && input.file_path) return escapeHtml(input.file_path);
    if (tool.name === "Write" && input.file_path) return escapeHtml(input.file_path);
    if (tool.name === "Edit" && input.file_path) return escapeHtml(input.file_path);
    if (tool.name === "Bash" && input.command) {
      const cmd = input.command.length > 60
        ? input.command.substring(0, 60) + "..."
        : input.command;
      return escapeHtml(cmd);
    }
    if (tool.name === "Glob" && input.pattern) return escapeHtml(input.pattern);
    if (tool.name === "Grep" && input.pattern) return escapeHtml(input.pattern);
    if (tool.name === "Task" && input.description) return escapeHtml(input.description);
    if (tool.name === "WebFetch" && input.url) return escapeHtml(input.url);
    return "";
  }

  // ── Search ──
  const searchInput = document.getElementById("search");
  let searchTimeout;
  searchInput.addEventListener("input", (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchQuery = e.target.value.trim();
      renderSessionList();
    }, 200);
  });

  // ── Keyboard shortcuts ──
  document.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === "k") {
      e.preventDefault();
      searchInput.focus();
    }
    if (e.key === "Escape" && document.activeElement === searchInput) {
      searchInput.value = "";
      searchQuery = "";
      renderSessionList();
      searchInput.blur();
    }
  });

  // ── Init ──
  loadSessions();
})();
</script>
</body>
</html>
