# 서브에이전트 지연이슈 종합 대응계획

> 작성일: 2026-02-25
> 기반 세션: d00b9d00-2461-46b5-b9e9-61bd3c97dbfa
> 관련 handoff: `handoff/handoff_20260225_07_서브에이전트-지연이슈-분석.md`

---

## 1. 사건 개요

3개 서브에이전트 병렬 실행 중 1개 거부 → Plan Mode 재활성화 → **~45분 교착** (사용자 체감 57분).
에이전트 실행 자체는 5~6분이었으나, Plan Mode 재진입으로 메인 에이전트가 읽기 전용 상태에 갇힘.

---

## 2. 근본 원인

### 2.1 직접 원인: Plan Mode 의도치 않은 재활성화

에이전트 1개가 거부(rejected)되면서, 거부 응답의 `<system-reminder>`에 **Plan Mode 재진입 지시**가 포함됨. 이전 Plan 단계에서 남은 plan 파일(`~/.claude/plans/parallel-fluttering-nest.md`)이 트리거 역할.

### 2.2 기여 요인 (알려진 버그 조합)

| 이슈 | 상태 | 역할 |
|------|------|------|
| [#23754](https://github.com/anthropics/claude-code/issues/23754) | **Open** | ExitPlanMode 거부 시 세션 재시작 → 컨텍스트 전체 손실 |
| [#12838](https://github.com/anthropics/claude-code/issues/12838) | Closed (duplicate) | Plan 파일이 세션 종료 후에도 `~/.claude/plans/`에 잔존 → 다음 세션/이벤트에서 stale context로 혼동 |
| [#4750](https://github.com/anthropics/claude-code/issues/4750) | Closed | Main Agent가 Plan Mode일 때 Subagent의 권한 상속이 문서화되지 않음 |
| [#14259](https://github.com/anthropics/claude-code/issues/14259) | **Open** | PrePlanMode/PostPlanMode 훅 이벤트 미구현 → plan 라이프사이클 제어 불가 |

### 2.3 메커니즘 체인

```
Plan Mode에서 계획 수립 → ExitPlanMode 승인 → plan 파일 잔존
→ 서브에이전트 3개 병렬 발사 → 1개 사용자 거부(rejected)
→ 거부 응답에 system-reminder: "plan file exists → Re-entering Plan Mode"
→ 메인 에이전트 Plan Mode 재진입 (읽기 전용)
→ 나머지 2개 에이전트 결과 도착해도 후속 작업(파일 쓰기) 불가
→ ~45분 교착
```

---

## 3. GitHub 이슈 상세

### 3.1 Issue #23754 — ExitPlanMode 거부 시 세션 재시작

- **증상**: ExitPlanMode를 거부/중단하면 CLI가 현재 세션을 종료하고 새 세션 생성
- **손실**: skill-injected preferences, 탐색 결과, 작업 진행 상태 전체
- **이번 사건과의 관계**: 에이전트 거부 → Plan Mode 재진입 → ExitPlanMode 필요 → 추가 컨텍스트 손실 리스크
- **관련 이슈**: #15755 (PermissionRequest Allow 미작동), #19623 (ExitPlanMode AbortError)

### 3.2 Issue #12838 — Plan 파일 잔존으로 세션 간 오염

- **증상**: Session A의 plan 파일이 Session B에서 로드 → stale context로 혼동
- **이번 사건과의 관계**: ExitPlanMode 후 plan 파일이 잔존해 있어 에이전트 거부 시 재진입 트리거 제공
- **상태**: Duplicate로 닫힘, 근본 수정 미확인

### 3.3 Issue #14259 — PrePlanMode/PostPlanMode 훅 요청

- **요청 내용**: Plan Mode 라이프사이클에 훅을 걸어 plan 파일 아카이빙, 상태 검증 가능하게
- **제시된 사용 사례**:
  - 기존 plan 자동 아카이브
  - 사전 조건 검증 (git clean 상태)
  - Plan 처리 후 다운스트림 워크플로우 트리거
- **이번 사건에의 의미**: 이 훅이 있었다면 PostPlanMode에서 plan 파일 정리 가능했음

### 3.4 Issue #4750 — Plan Mode에서 서브에이전트 권한 상속 모호

- **문제**: Main Agent가 Plan Mode일 때 Subagent가 modifying action을 수행할 수 있는지 문서화 안 됨
- **상태**: Closed (Jul 2025)
- **권장 모범 사례**: subagent 정의에서 `tools` 배열로 명시적 권한 제한

### 3.5 참고: Armin Ronacher의 Plan Mode 분석

[What Actually Is Claude Code's Plan Mode?](https://lucumr.pocoo.org/2025/12/17/what-is-plan-mode/) (2025-12-17)

- Plan Mode는 **프롬프트 주입(prompt steering)**으로 구현됨
- Tool permission을 상속하지 않아 plan mode에서 계속 승인 요청 발생
- 일부 도구(Amp 등)는 Plan Mode를 제거하는 추세
- 대안: handoff 마크다운 파일을 통한 반복 협업 방식

---

## 4. 검증 필요 항목

| # | 항목 | 방법 | 우선순위 |
|---|------|------|----------|
| V1 | Plan Mode 재활성화가 플랫폼 동작인지 system-reminder 기반인지 | 에이전트 거부 시 system-reminder 내용 재현 테스트 | 높음 |
| V2 | plan 파일 수동 삭제 시 재활성화 방지 효과 | ExitPlanMode 후 plan 파일 삭제 → 에이전트 거부 시 동작 확인 | 높음 |
| V3 | SessionStart 훅에서 plan 파일 정리 가능 여부 | 훅에서 `~/.claude/plans/*.md` 정리 스크립트 실행 테스트 | 중간 |
| V4 | `max_turns` 설정이 교착 방지에 효과적인지 | 제한된 turns로 에이전트 실행 후 타임아웃 동작 확인 | 낮음 |

---

## 5. 대응 방안

### 5.1 단기 — 즉시 적용 (CLAUDE.md 규칙 + 운영 습관)

| # | 방안 | 구현 방법 | 효과 |
|---|------|-----------|------|
| S1 | **에이전트 거부 시 graceful fallback** | 글로벌 CLAUDE.md에 규칙 추가: "서브에이전트 N개 중 일부 거부 시 나머지 결과로 계속 진행. Plan Mode 재진입하지 말 것" | 교착 방지 |
| S2 | **Plan Mode 의도치 않은 재활성화 시 즉시 탈출** | CLAUDE.md에 규칙 추가: "Plan Mode가 의도치 않게 재활성화되면 즉시 ExitPlanMode 시도 + 사용자 알림" | 교착 시간 최소화 |
| S3 | **병렬 에이전트 발사 전 권한 상태 확인** | 서브에이전트 실행 전 permissionMode가 plan이 아닌지 확인하는 습관 | 사전 예방 |
| S4 | **Plan → 실행 전환 시 plan 파일 존재 확인** | ExitPlanMode 직후 plan 파일 잔존 여부 확인 (수동) | #12838 대응 |

### 5.2 중기 — 훅/자동화

| # | 방안 | 구현 방법 | 의존성 |
|---|------|-----------|--------|
| M1 | **SessionStart 훅에서 stale plan 파일 정리** | `ensure-commands.js` 패턴으로 `~/.claude/plans/*.md` 정리 훅 추가 | V3 검증 후 |
| M2 | **웹 리서치 에이전트 `max_turns` 설정** | Task 호출 시 `max_turns: 30` 명시로 무한 대기 방지 | 없음 |
| M3 | **PostPlanMode 훅 대체 구현** | `UserPromptSubmit` 훅에서 plan 파일 존재 감지 → 자동 아카이빙 | #14259 미구현 동안 |
| M4 | **병렬 실행 패턴을 2+1로 전환** | 리스크 높은 에이전트(외부 fetch 多)는 별도 실행, 안전한 것만 병렬 | 운영 규칙 |

### 5.3 장기 — 플랫폼 수정 대기

| # | 이슈 | 기대 효과 | 현재 상태 |
|---|------|-----------|-----------|
| L1 | #23754 수정 | ExitPlanMode 거부 시 세션 유지 | Open, 공식 수정 미정 |
| L2 | #14259 구현 | PrePlanMode/PostPlanMode 훅으로 plan 라이프사이클 제어 | Open, Feature Request |
| L3 | #12838 근본 수정 | Plan 파일 세션 스코프화 (세션 종료 시 자동 정리) | Closed/Duplicate |

---

## 6. 권장 CLAUDE.md 추가 규칙 (초안)

```markdown
## Plan Mode 안전 규칙

- ExitPlanMode 후 서브에이전트를 병렬 실행할 때, 1개 거부로 전체가 중단되지 않도록 주의.
  거부된 에이전트를 제외하고 나머지 결과로 계속 진행하라.
- Plan Mode가 의도치 않게 재활성화되면 즉시 ExitPlanMode를 시도하고 사용자에게 알려라.
  절대 Plan Mode 상태에서 자동 대기하지 마라.
- 서브에이전트 병렬 실행 전 permissionMode가 plan이 아닌지 확인하라.
```

> **적용 위치 결정 필요**: 글로벌 CLAUDE.md(`~/.claude/`) vs 프로젝트 CLAUDE.md

---

## 7. 참고 자료

- [Issue #23754](https://github.com/anthropics/claude-code/issues/23754) — ExitPlanMode 거부 시 세션 재시작
- [Issue #12838](https://github.com/anthropics/claude-code/issues/12838) — Plan 파일 잔존 → 세션 오염
- [Issue #14259](https://github.com/anthropics/claude-code/issues/14259) — PostPlanMode 훅 요청 (Open)
- [Issue #4750](https://github.com/anthropics/claude-code/issues/4750) — Plan Mode 서브에이전트 권한 상속 모호
- [Armin Ronacher — What Actually Is Claude Code's Plan Mode?](https://lucumr.pocoo.org/2025/12/17/what-is-plan-mode/)
- Handoff: `handoff/handoff_20260225_07_서브에이전트-지연이슈-분석.md`
