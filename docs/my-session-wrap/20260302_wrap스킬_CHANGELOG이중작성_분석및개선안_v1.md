# wrap 스킬 CHANGELOG 이중 작성 문제 — 분석 및 개선안

**작성일**: 2026-03-02
**대상 스킬**: `my-session-wrap` → `/wrap`
**상태**: 분석 완료, 실행 대기 중

---

## §1 발단 — 실제 관찰된 문제

`/wrap` 실행 시 다음 시퀀스가 발생:

```
1. CHANGELOG 업데이트 (작업 산출물용)
2. 커밋 #1: 작업물 + CHANGELOG
3. Handoff 문서 생성
4. 커밋 #2 시도 → pre-commit hook 차단
   ✗ 커밋 차단: CHANGELOG.md가 업데이트되지 않았습니다.
5. CHANGELOG 재업데이트 (handoff용)  ← 불필요한 반복
6. 커밋 #2: handoff + CHANGELOG
```

미커밋 작업물이 복수 관심사(N건)인 경우 N+1번의 CHANGELOG 작성이 발생.

---

## §2 현재 상태 분석

### SKILL.md 설계 의도 vs 실제 동작

| 항목 | SKILL.md 의도 | 실제 AI 동작 |
|---|---|---|
| handoff 생성 시점 | 커밋 전 (Step 2) | 커밋 후 |
| 커밋 방식 | `git add -A` → 단일 커밋 | 관심사별 분리 커밋 |
| CHANGELOG 횟수 | 1회 | N+1회 |

### 근본 원인: 규칙 충돌

| 규칙 | 출처 | 지시 |
|---|---|---|
| 단일 커밋으로 wrap | SKILL.md Step 3-2 | `git add -A` → 1회 커밋 |
| 한 커밋 = 한 관심사 | 글로벌 CLAUDE.md | 서브폴더·맥락 다른 문서는 커밋 분리 |
| 커밋 전 CHANGELOG 필수 | 글로벌 CLAUDE.md + pre-commit hook | 매 커밋마다 CHANGELOG 포함 |

**AI는 스킬보다 글로벌 규칙을 우선 적용** → SKILL.md 미준수 → 관심사별 분리 커밋 → handoff 별도 커밋 → CHANGELOG 재요구.

> **핵심**: SKILL.md 미준수가 문제가 아니라, 글로벌 규칙과의 충돌로 인한 불가피한 이탈이 문제.

---

## §3 개선 방향 검토

### 전제 조건

- **스킬은 명시적 호출** → 실행 시점에 지시를 읽으므로 준수율 높음
- **글로벌 규칙** → 항상 컨텍스트에 로드되지만 다른 규칙과 충돌 시 AI가 즉석 판단 → 준수율 불안정
- 따라서 **SKILL.md 안에서 완결**되어야 준수율을 보장할 수 있음

---

## §4 옵션별 워크플로우 비교

### 케이스 A — 단일 관심사 (미커밋 작업물 1건)

| 순서 | 현재 (문제 상태) | 옵션 1: 커밋 안 함 | 옵션 2: CL 범위 축소 | 옵션 3: 단일 커밋 |
|:---:|---|---|---|---|
| ① | CL 업데이트 | CL 업데이트 | CL 업데이트 | Handoff 작성 |
| ② | 커밋: 작업물+CL | 커밋: 작업물+CL | 커밋: 작업물+CL | CL 업데이트 |
| ③ | Handoff 작성 | Handoff 작성 (uncommitted) | Handoff 작성 | 커밋: 작업물+handoff+CL |
| ④ | 커밋 시도 → **hook 차단** | — | 커밋: handoff (CL 없이) | — |
| ⑤ | CL 재업데이트 | — | — | — |
| ⑥ | 커밋: handoff+CL | — | — | — |
| **커밋 수** | 2 | 1 | 2 | 1 |
| **CL 작성** | ❌ 2회 | ✅ 1회 | ✅ 1회 | ✅ 1회 |
| **handoff 상태** | ✅ committed | ❌ uncommitted | ✅ committed | ✅ committed |
| **관심사 분리** | ✅ 깔끔 | ✅ 깔끔 | ✅ 깔끔 | ⚠️ 혼합 |

### 케이스 B — 복수 관심사 (미커밋 작업물 2건)

| 순서 | 현재 (문제 상태) | 옵션 1: 커밋 안 함 | 옵션 2: CL 범위 축소 | 옵션 3: 단일 커밋 |
|:---:|---|---|---|---|
| ① | CL 업데이트 (A) | CL 업데이트 (A) | CL 업데이트 (A) | Handoff 작성 |
| ② | 커밋: 작업물A+CL | 커밋: 작업물A+CL | 커밋: 작업물A+CL | CL 업데이트 (A+B 통합) |
| ③ | CL 업데이트 (B) | CL 업데이트 (B) | CL 업데이트 (B) | 커밋: A+B+handoff+CL |
| ④ | 커밋: 작업물B+CL | 커밋: 작업물B+CL | 커밋: 작업물B+CL | — |
| ⑤ | Handoff 작성 | Handoff 작성 (uncommitted) | Handoff 작성 | — |
| ⑥ | 커밋 시도 → **hook 차단** | — | 커밋: handoff (CL 없이) | — |
| ⑦ | CL 재업데이트 | — | — | — |
| ⑧ | 커밋: handoff+CL | — | — | — |
| **커밋 수** | 3 | 2 | 3 | 1 |
| **CL 작성** | ❌ 3회 (N+1) | ✅ 2회 (N) | ✅ 2회 (N) | ⚠️ 1회 (통합 기술) |
| **handoff 상태** | ✅ committed | ❌ uncommitted | ✅ committed | ✅ committed |
| **관심사 분리** | ✅ 깔끔 | ✅ 깔끔 | ✅ 깔끔 | ❌ 전부 혼합 |

---

## §5 옵션 종합 평가

| 평가 항목 | 현재 | 옵션 1: 커밋 안 함 | 옵션 2: CL 범위 축소 | 옵션 3: 단일 커밋 |
|---|---|---|---|---|
| CL 불필요 반복 제거 | ❌ | ✅ 완전 해소 | ✅ 완전 해소 | ✅ 완전 해소 |
| 관심사 분리 유지 | ✅ | ✅ | ✅ | ❌ |
| handoff push 안전성 | ✅ | ❌ uncommitted | ✅ | ✅ |
| 규칙 변경 최소성 | — | ████░░ SKILL.md만 | ██░░░░ 글로벌+SKILL.md | ████░░ SKILL.md만 |
| 구현 단순성 | — | ██████ | ████░░ | ████░░ |
| 복수 관심사 대응 | ❌ | ✅ | ✅ | ❌ |
| 글로벌 규칙 충돌 | ❌ 있음 | ✅ 없음 | ✅ 해소 | ⚠️ 부분 |

### 옵션별 핵심 트레이드오프

**옵션 1 (커밋 안 함)**
- 장점: 가장 단순, 규칙 변경 없음, 구현 최소
- 단점: handoff가 uncommitted 상태 → git push 누락 위험

**옵션 2 (CL 범위 축소)**
- 장점: 관심사 분리 유지, handoff 안전하게 committed
- 단점: 글로벌 CLAUDE.md 수정 필요 → 하지만 **SKILL.md 안에서 우선순위 명시로 대체 가능**

**옵션 3 (단일 커밋)**
- 장점: CHANGELOG 1회, 커밋 1회로 가장 단순
- 단점: 복수 관심사가 하나의 커밋에 혼합 → "한 커밋 = 한 관심사" 위반

---

## §6 순서 변경으로 해결 가능한가?

> **결론: 불가능**

handoff는 세션 전체(모든 커밋 포함)를 요약해야 하므로 **반드시 마지막에 생성**된다. 따라서 별도 커밋이 구조적으로 불가피하며, CHANGELOG 규칙과의 충돌은 순서 변경으로 해소되지 않는다.

---

## §7 채택 방향 및 최종 계획

### 채택: 옵션 2 변형 — SKILL.md 단독 수정

글로벌 CLAUDE.md는 건드리지 않고, SKILL.md Step 3-2를 재구성하여 **스킬 안에서 우선순위를 명시**. 스킬은 명시적 호출 구조이므로 글로벌 규칙보다 준수율이 높다.

#### 수정 파일

`my-session-wrap/skills/my-session-wrap/SKILL.md` — Step 3 (129행~)

#### 현재 Step 3-2 → 교체 내용

**현재:**
```
git add -A
git commit -m "docs: [세션 작업 요약]"
```

**수정 후:**

**3-2a. 미커밋 작업물 커밋 (있을 경우)**
- 관심사별 분리 커밋 (글로벌 "한 커밋 = 한 관심사" 준수 — 충돌 없음)
- 각 커밋에 CHANGELOG 포함 (글로벌 CL 규칙 준수 — 충돌 없음)

**3-2b. Handoff 커밋**
- handoff 파일만 포함
- CHANGELOG 업데이트 불필요 — handoff는 세션 메타데이터이며 프로젝트 변경이 아님. 이 지시는 글로벌 CHANGELOG 규칙보다 우선한다.
- pre-commit hook 차단 시 `--no-verify` 사용
- 커밋 메시지: `docs(handoff): <한줄요약>`

#### 충돌 해소 매핑

| 글로벌 규칙 | 수정된 SKILL.md | 충돌 여부 |
|---|---|---|
| 모든 커밋에 CL 필수 | 3-2a: CL 포함 | ✅ 없음 (일치) |
| 모든 커밋에 CL 필수 | 3-2b: CL 면제 + 우선순위 명시 | ✅ 해소 |
| 한 커밋 = 한 관심사 | 3-2a: 관심사별 분리 | ✅ 없음 (일치) |

#### 리스크

- `--no-verify`가 CL 체크 외 다른 hook도 스킵 — 하지만 handoff 커밋은 `plugin.json`/`marketplace.json`을 건드리지 않으므로 실질적 위험 없음

---

## §8 검증 시나리오

1. **단일 관심사 프로젝트**에서 `/wrap` → CL 1회, 커밋 2개 (작업물+CL, handoff)
2. **복수 관심사 프로젝트**에서 `/wrap` → CL N회, 커밋 N+1개 (handoff에 CL 없음)
3. **pre-commit hook 있는 프로젝트**에서 handoff 커밋이 `--no-verify`로 통과하는지 확인

---

## §9 부록 — 현재 SKILL.md 구조 참조

| 섹션 | 위치 | 내용 |
|---|---|---|
| Step 1 | 상단 | Git 감지 (git status) |
| Step 1.5 | — | 프로젝트 CLAUDE.md 체크리스트 확인 |
| Step 2 | 70~120행 | Handoff 파일 생성 (세션ID 획득 → 경로 생성 → 작성) |
| Step 3 | 123~148행 | git commit (CHANGELOG → 커밋) |
| Step 4 | 151~172행 | 규칙 후보 확인 + 재개 안내 |

> **수정 범위**: Step 3 (129행~148행) — 커밋 단계만 교체
