# Session ID 확보 — 2차 테스트 기록

> 작성일: 2026-02-24
> 이전 문서: `세션id확보방안_20260224.md` (1차 조사·선정)
> 목적: 1차에서 채택한 UserPromptSubmit + 플러그인 hook이 실제 동작하는지 검증

---

## 1. 현재 상태 요약

1차 문서에서 **UserPromptSubmit** hook을 채택하고 구현 완료. 커밋 `0695574`까지 반영.
그러나 `/plugin update` 후 새 세션에서 `.claude/.current-session-id` 파일이 생성되지 않는 문제 발생.

---

## 2. 검증한 가설과 결과

### 가설 1: 스크립트 자체 버그

**결과: 기각**

수동 실행 시 정상 동작:
```bash
echo '{"session_id":"test-uuid-123","cwd":"/c/Users/ahnbu/.claude/my-claude-plugins"}' \
  | bash capture-session-id.sh
# → .claude/.current-session-id에 "test-uuid-123" 정상 기록
```

### 가설 2: jq 미설치 또는 PATH 문제

**결과: 기각**

```bash
which jq  # → /usr/bin/jq 존재
```

### 가설 3: hook이 발동되지 않음

**결과: 부분 기각**

시스템 리마인더에 `UserPromptSubmit hook success: Success`가 매 프롬프트마다 출력됨.
→ Claude Code가 hook 이벤트를 **인식하고 처리**하고 있음.

### 가설 4: hook "success"는 보고되지만 command가 실제 실행되지 않음

**결과: 유력 — 현재 검증 중**

디버그 코드를 삽입하여 테스트:

| 디버그 방법 | 출력 경로 | 파일 생성됨? |
|-------------|-----------|:---:|
| 스크립트 내 `echo > /tmp/...` | `/tmp/hook-debug-stdin.json` | ❌ |
| 스크립트 내 `echo > /c/Users/ahnbu/...` | `~/hook-debug-stdin.json` | ❌ |
| 설치 경로 직접 수정 후 재시도 | 동일 | ❌ |

**스크립트 첫 줄의 무조건 실행 구문(`echo "HOOK_EXECUTED_AT=..."`)조차 파일을 생성하지 않음.**
→ bash 프로세스 자체가 fork되지 않는 것으로 판단.

### 가설 5: `bash "..."` 명령어 형식 문제

**결과: 검증 중 (2차 테스트 대상)**

Claude Code 공식 문서의 플러그인 hook 예시:
```json
// 공식 예시 — bash 접두사 없이 스크립트 경로만 사용
{
  "command": "${CLAUDE_PLUGIN_ROOT}/scripts/format-code.sh"
}
```

기존 코드:
```json
// 우리 코드 — bash를 명시적으로 호출
{
  "command": "bash \"${CLAUDE_PLUGIN_ROOT}/hooks/capture-session-id.sh\""
}
```

**차이점**: 공식 예시는 스크립트를 직접 실행 (shebang 기반), 우리 코드는 `bash`를 명시적으로 호출.
Claude Code의 hook 실행기가 `bash "..."` 형식을 제대로 처리하지 못할 가능성.

---

## 3. 2차 테스트에서 적용한 변경

### 변경 1: hooks.json — bash 접두사 제거

```diff
- "command": "bash \"${CLAUDE_PLUGIN_ROOT}/hooks/capture-session-id.sh\""
+ "command": "${CLAUDE_PLUGIN_ROOT}/hooks/capture-session-id.sh"
```

### 변경 2: capture-session-id.sh — 디버그 코드 삽입

```bash
INPUT=$(cat)

# DEBUG: stdin 덤프 (검증 후 제거)
echo "$INPUT" > /c/Users/ahnbu/hook-debug-stdin.json

SESSION_ID=$(echo "$INPUT" | jq -r '.session_id // empty')
CWD=$(echo "$INPUT" | jq -r '.cwd // empty')

echo "SESSION_ID=$SESSION_ID CWD=$CWD" > /c/Users/ahnbu/hook-debug-parsed.txt

if [ -n "$SESSION_ID" ] && [ -n "$CWD" ]; then
  mkdir -p "$CWD/.claude"
  echo "$SESSION_ID" > "$CWD/.claude/.current-session-id"
fi
```

### 참고: SessionStart hook의 ensure-commands.js

같은 hooks.json의 SessionStart hook은 `node "..."` 형식으로 **정상 동작**한다:
```json
"command": "node \"${CLAUDE_PLUGIN_ROOT}/hooks/ensure-commands.js\""
```

이는 node가 Windows에서 네이티브 실행 가능하기 때문일 수 있음.
반면 bash는 MSYS/Git Bash 환경에서만 사용 가능하여, Claude Code의 hook 실행기(Node.js child_process)가
bash를 찾지 못하거나, shebang(`#!/bin/bash`)을 해석하지 못할 수 있음.

---

## 4. 검증 절차 (2차)

### 사전 조건
- [x] 소스 코드 수정 완료 (hooks.json + capture-session-id.sh)
- [ ] `/plugin update` 실행
- [ ] 새 세션 시작

### 확인 항목

새 세션에서 프롬프트 1개 입력 후:

```bash
# 1. 디버그 파일 — 스크립트 실행 여부
cat ~/hook-debug-stdin.json
cat ~/hook-debug-parsed.txt

# 2. 실제 목표 파일 — session_id 저장 여부
cat .claude/.current-session-id
```

### 결과 판정표

| ~/hook-debug-*.txt | .claude/.current-session-id | 판정 |
|:---:|:---:|------|
| 있음 | 있음 | **성공** — bash 접두사가 원인이었음. 디버그 제거 후 커밋 |
| 있음 | 없음 | 스크립트 실행됨, cwd/session_id 파싱 문제. 디버그 내용으로 원인 파악 |
| 없음 | 없음 | bash 접두사 제거로는 해결 안 됨. **가설 6으로 이동** |

---

## 5. 다음 가설 (2차 실패 시)

### 가설 6: Windows에서 shebang 미해석

Claude Code의 hook 실행기가 Node.js `child_process.exec()`을 사용한다면,
Windows에서 `.sh` 파일의 `#!/bin/bash` shebang을 해석하지 못할 수 있음.

**대응안**: bash 스크립트를 Node.js 스크립트로 변환
```json
"command": "node \"${CLAUDE_PLUGIN_ROOT}/hooks/capture-session-id.js\""
```

### 가설 7: `${CLAUDE_PLUGIN_ROOT}` 미확장

환경변수가 확장되지 않아 잘못된 경로로 실행을 시도할 수 있음.

**대응안**: `${CLAUDE_PLUGIN_ROOT}` 대신 절대경로로 테스트

---

## 6. 교훈 (진행 중)

1. **설치 경로 직접 수정 금지**: `~/.claude/plugins/marketplaces/...`는 `/plugin update` 시 덮어씌워짐. 디버깅 목적이라도 소스 → update → 검증 순서를 지켜야 함.
2. **"hook success" ≠ command 실행**: Claude Code의 hook success 메시지는 hook 이벤트 처리를 의미하며, command 프로세스의 실제 실행 성공과는 다를 수 있음.
3. **Windows/MSYS 환경 특수성**: `node` 명령은 동작하지만 `bash` 또는 shebang 기반 스크립트는 동작하지 않을 수 있음.
