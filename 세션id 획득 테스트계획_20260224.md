# Hook Session ID 실측 테스트 계획

> 목적: SessionStart / Stop / UserPromptSubmit 3개 hook에서 `session_id`가 stdin JSON으로 전달되는지 실측 검증
> 작성일: 2026-02-24
> 상태: 준비 완료 (settings.json에 3개 hook 등록됨)

---

## 1. 사전 조건

### 1.1 settings.json에 등록된 테스트 hook (완료)

```json
"Stop": [
  {
    "hooks": [
      {
        "type": "command",
        "command": "bash -c 'cat > /tmp/claude-hook-test-stop.json'",
        "timeout": 3000
      }
    ]
  }
],
"SessionStart": [
  {
    "matcher": "startup",
    "hooks": [
      {
        "type": "command",
        "command": "bash -c 'cat > /tmp/claude-hook-test-sessionstart.json'",
        "timeout": 3000
      }
    ]
  }
],
"UserPromptSubmit": [
  {
    "hooks": [
      {
        "type": "command",
        "command": "bash -c 'cat > /tmp/claude-hook-test-userprompt.json'",
        "timeout": 3000
      }
    ]
  }
]
```

### 1.2 기존 덤프 파일 정리 (완료)

```bash
rm -f /tmp/claude-hook-test-*.json
```

### 1.3 필요 도구

- `jq` — JSON 파싱 (설치 확인: `which jq` ✅)
- `bash` — hook 실행 셸 (MSYS 환경 ✅)

---

## 2. 테스트 절차

### Step 1: 현재 세션 종료

```
/exit 또는 Ctrl+C로 현재 세션 종료
```

- 이유: SessionStart hook은 **새 세션 시작 시에만** 발동 (matcher: "startup")

### Step 2: 새 세션 시작

```bash
cd C:\Users\ahnbu\.claude\my-claude-plugins
claude
```

- 예상: SessionStart hook 발동 → `/tmp/claude-hook-test-sessionstart.json` 생성

### Step 3: 간단한 프롬프트 입력

```
hello
```

- 예상:
  - UserPromptSubmit hook 발동 → `/tmp/claude-hook-test-userprompt.json` 생성
  - (응답 완료 후) Stop hook 발동 → `/tmp/claude-hook-test-stop.json` 생성

### Step 4: 결과 확인 — 3개 파일 존재 여부

```bash
echo "=== 파일 존재 여부 ===" && \
ls -la /tmp/claude-hook-test-sessionstart.json 2>/dev/null || echo "SessionStart: 파일 없음" && \
ls -la /tmp/claude-hook-test-stop.json 2>/dev/null || echo "Stop: 파일 없음" && \
ls -la /tmp/claude-hook-test-userprompt.json 2>/dev/null || echo "UserPromptSubmit: 파일 없음"
```

### Step 5: 결과 확인 — session_id 포함 여부

```bash
echo "========== SessionStart =========="
cat /tmp/claude-hook-test-sessionstart.json 2>/dev/null | jq '{session_id, hook_event_name, cwd, transcript_path}' || echo "파일 없음 또는 파싱 실패"

echo "========== Stop =========="
cat /tmp/claude-hook-test-stop.json 2>/dev/null | jq '{session_id, hook_event_name, cwd, transcript_path}' || echo "파일 없음 또는 파싱 실패"

echo "========== UserPromptSubmit =========="
cat /tmp/claude-hook-test-userprompt.json 2>/dev/null | jq '{session_id, hook_event_name, cwd, transcript_path}' || echo "파일 없음 또는 파싱 실패"
```

### Step 6: 전체 JSON 구조 확인 (각 hook별 전달 필드 비교)

```bash
echo "========== SessionStart (full) =========="
cat /tmp/claude-hook-test-sessionstart.json 2>/dev/null | jq 'keys' || echo "파일 없음"

echo "========== Stop (full) =========="
cat /tmp/claude-hook-test-stop.json 2>/dev/null | jq 'keys' || echo "파일 없음"

echo "========== UserPromptSubmit (full) =========="
cat /tmp/claude-hook-test-userprompt.json 2>/dev/null | jq 'keys' || echo "파일 없음"
```

---

## 3. 기대 결과

| Hook | 파일 생성 | session_id 포함 | 발동 시점 |
|------|----------|----------------|-----------|
| SessionStart | ✅ 예상 | ✅ 예상 | 세션 시작 직후 |
| Stop | ✅ 확인됨 (이전 테스트) | ✅ 확인됨 | 응답 완료 후 |
| UserPromptSubmit | ? 미확인 | ? 미확인 | 프롬프트 제출 직후 |

---

## 4. 판단 기준

### 4.1 필수 조건 (Pass/Fail)

| 기준 | 설명 |
|------|------|
| session_id 포함 | stdin JSON에 `session_id` 필드가 존재하고 유효한 UUID인가 |
| 파일 생성 | 덤프 파일이 정상적으로 생성되는가 |
| 3개 session_id 일치 | 같은 세션에서 3개 hook의 session_id가 동일한가 |

### 4.2 비교 기준 (최적 hook 선정용)

| 기준 | 가중치 | 설명 |
|------|--------|------|
| 발동 신뢰성 | ★★★ | 파일이 확실하게 생성되는가 |
| 성능 효율 | ★★☆ | 불필요한 반복 실행이 없는가 |
| /wrap 시점 가용 | ★★★ | wrap 실행 시점에 session_id가 이미 확보되어 있는가 |
| 플러그인 배치 가능 | ★☆☆ | 플러그인 hooks.json에 정의 가능한가 |
| 추가 필드 유용성 | ★☆☆ | transcript_path 등 부가 정보 활용 가능성 |

---

## 5. 테스트 후 결과 기록 양식

아래 표를 테스트 후 채워 넣을 것:

### 5.1 파일 생성 결과

| Hook | 파일 생성 | 파일 크기 | 비고 |
|------|----------|----------|------|
| SessionStart | | | |
| Stop | | | |
| UserPromptSubmit | | | |

### 5.2 session_id 비교

| Hook | session_id 값 | 유효 UUID | 3개 일치 |
|------|--------------|----------|---------|
| SessionStart | | | |
| Stop | | | |
| UserPromptSubmit | | | |

### 5.3 전달 필드 목록

| Hook | 전달 필드 (keys) |
|------|-----------------|
| SessionStart | |
| Stop | |
| UserPromptSubmit | |

### 5.4 최종 선정

- 선정 hook: _______________
- 선정 이유: _______________

---

## 6. 테스트 후 정리 작업

테스트 완료 후 settings.json에서 테스트용 hook 3개를 제거할 것:

```bash
# 테스트 덤프 파일 정리
rm -f /tmp/claude-hook-test-*.json

# settings.json에서 테스트 hook 제거 (수동 또는 Claude Code로)
# → SessionStart, Stop, UserPromptSubmit 덤프 hook 제거
# → 기존 PostToolUse hook은 유지
```
